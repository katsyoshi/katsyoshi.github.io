<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>katsyoshi のめもみたいなの | It’s a memos.</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="katsyoshi のめもみたいなの" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="It’s a memos." />
<meta property="og:description" content="It’s a memos." />
<link rel="canonical" href="http://localhost:3000/" />
<meta property="og:url" content="http://localhost:3000/" />
<meta property="og:site_name" content="katsyoshi のめもみたいなの" />
<meta property="og:type" content="website" />
<link rel="next" href="http://localhost:3000/page/2/" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="katsyoshi のめもみたいなの" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebSite","description":"It’s a memos.","headline":"katsyoshi のめもみたいなの","name":"katsyoshi のめもみたいなの","url":"http://localhost:3000/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:3000/feed.xml" title="katsyoshi のめもみたいなの" /></head>
<body><header class="site-header" role="banner">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">katsyoshi のめもみたいなの</a>
  </div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <!-- Pagination links -->
<div class="pagination">
  
    <span class="previous">Previous</span>
  
  <span class="page_number ">
    Page: 1 of 11
  </span>
  
    <a href="/page/2/" class="next">Next</a>
  
</div>



  <h1><a href="/blog/2023/05/25/vaporware-for-ruby-compiler/">趣味はvaporware造りです v.0.0.1</a></h1>
  <p class="author">
    <span class="date">2023-05-25 23:59:59 +0900</span>
  </p>
  <div class="content">
    <p><a href="htttps://rubykaigi.org/2023"><strong>RubyKaigi2023</strong></a>に行ってきたのは<a href="/blog/2023/05/15/ruby-kaigi-2023-at-matsumoto/">別エントリ</a>にしたのでこのエントリでは <a href="https://rubykaigi.org/2023/presentations/lt/"><em>LT</em></a> で話しした内容の説明などをしていこうかと思います。</p>

<h2 id="presentation">Presentation</h2>

<iframe class="speakerdeck-iframe" style="border: 0px none; background: rgba(0, 0, 0, 0.1) padding-box; margin: 0px; padding: 0px; border-radius: 6px; box-shadow: rgba(0, 0, 0, 0.2) 0px 5px 40px; width: 100%; height: auto; aspect-ratio: 560 / 420;" src="https://speakerdeck.com/player/59e0f2da2d014f3e9b1d1d7633ef000f" title="Building Ruby Native Extension using Ruby" allowfullscreen="true" data-ratio="1.3333333333333333" frameborder="0"></iframe>

<h2 id="lt申し込みまで">LT申し込みまで</h2>

<p><a href="https://rubykaigi.org/2023"><strong>RubyKaigi2023</strong></a> 松本でやるし発表もしたいが、ネタがないなとおもってたら本編の方の <em>CFP</em><sup id="fnref:cfp" role="doc-noteref"><a href="#fn:cfp" class="footnote" rel="footnote">1</a></sup> が閉じられてた<sup id="fnref:cfpdate" role="doc-noteref"><a href="#fn:cfpdate" class="footnote" rel="footnote">2</a></sup>。
とはいえ今年は <strong>COVID-19</strong> の制限も無くなるから <em>LT</em> あるとおもうので <em>LT</em> 出せたらいいなあと考えてた。
そうこうしているうちに <a href="https://30.ruby.or.jp/"><strong>Ruby30th</strong></a> で今はまだないものだけど…って matz がいったものを造ろうとなりました。</p>

<p><em>LT</em> の応募サイト開くまでにネタが幸い見つけることができ、実装をはじめることにした。</p>

<h2 id="実装">実装</h2>

<p>ということで、通るかどうかわからないですが、発表できるように準備をはじめました。
準備といっても実際は実装どこまでできましたーというような発表にする予定だったので
そのまま実装をしています。</p>

<p>実装予定は発表にもあった通り、以下の予定ですすめて、最後に <a href="https://docs.ruby-lang.org/ja/latest/library/fiddle.html"><code class="language-plaintext highlighter-rouge">fiddle</code></a> で読み込めるように実装していました。</p>

<ol>
  <li>四則演算: <code class="language-plaintext highlighter-rouge">Integer</code> の計算ができること</li>
  <li>変数: 変数が使えること</li>
  <li>制御構文: <code class="language-plaintext highlighter-rouge">for</code> や <code class="language-plaintext highlighter-rouge">if</code> などの基本的な制御構文が使えること</li>
  <li>メソッド: メソッドが定義でき、利用できこと</li>
</ol>

<p>を目標に実装をすすめていましたのでそれぞれの進捗を</p>

<h3 id="四則演算">四則演算</h3>

<p>とくに詰まる点もなく、<em>AST</em> をもとに <em>assembler</em> へ変換するだけでいけた。</p>

<h3 id="変数">変数</h3>

<p>これが一番大変だった。<a href="https://www.sigbus.info/compilerbook">教科書</a> を <code class="language-plaintext highlighter-rouge">cherry-picking</code> しながら進めてたために、
実装でわからん部分が出てきたのでインターネット介して <code class="language-plaintext highlighter-rouge">gdb</code> リモートデバッグの講習を受けながら実装。
もともとここか制御構文までで終わるだろうなあと予想してたが、<code class="language-plaintext highlighter-rouge">SEGV</code> 出しながらもなんとかくりあ。</p>

<h3 id="制御構文">制御構文</h3>

<p>はじめは素直に <code class="language-plaintext highlighter-rouge">if</code> 文を実装。ここも上記の理由によりなんもわからんとなり、<a href="https://github.com/ktateish/9cc">別の人の実装</a> を参考に実装。
<code class="language-plaintext highlighter-rouge">if</code> 文だけじゃつまんないというか、とくになにもできないのでループ文を追加しようとしました。
はじめは <code class="language-plaintext highlighter-rouge">for</code> 文を実装しようと考えましたが、なんとここで重大なことに気がつきました。
<strong>Ruby</strong> の <code class="language-plaintext highlighter-rouge">for</code> のことはなにもしらない。ということに。そういえば <code class="language-plaintext highlighter-rouge">for x in 1..10; puts x;end</code> とか書けるけど
そもそも <code class="language-plaintext highlighter-rouge">Range</code> クラスや <code class="language-plaintext highlighter-rouge">Array</code> 作る必要あるよな？ということで一旦 <code class="language-plaintext highlighter-rouge">for</code> はやめに。</p>

<p>ということでここは <code class="language-plaintext highlighter-rouge">while</code> 文を実装して、<a href="https://ja.wikipedia.org/wiki/%E3%83%95%E3%82%A3%E3%83%9C%E3%83%8A%E3%83%83%E3%83%81%E6%95%B0"><strong><code class="language-plaintext highlighter-rouge">fibonacci</code> 数</strong></a> を求めることができるようになりました。</p>

<h3 id="メソッド">メソッド</h3>

<p>ここは変数、制御構文ができれば作るだけなら問題はなかったように思えます。
ただほんとうに作るだけだったので、引数なし、定数を返すだけのメソッドの確認しか行なっていないです。
ここの実装にたどり着くとは思っておらず、最後のRubyKaigi直前の6連休に入ってから実装できてしまったので
あんまりブラッシュアップできていないです。
引数の扱い、変数の利用、などなど確認をとれておらずにいますが動いたので <code class="language-plaintext highlighter-rouge">fiddle</code> で読み込めるように。</p>

<h3 id="fiddle-で利用できるようにする">Fiddle で利用できるようにする</h3>

<p>定義したメソッドを <strong>C言語</strong> の関数として見えるようにしてあげればいいので、
そうしたら、あっさりとうごいてしまった<sup id="fnref:yoteigai" role="doc-noteref"><a href="#fn:yoteigai" class="footnote" rel="footnote">3</a></sup>。この時点で連休の終わりの方だったのは覚えている</p>

<h2 id="発表準備">発表準備</h2>

<p>もともとGW前の連休には実装を終らせてGWの連休中に発表資料作成とできたところまでの実装のブラッシュアップを
行なう予定でしたが、目標の実装が見えてるとなるとどうしても実装したくなって実装の方を進めてました。</p>

<p>もともと発表は <a href="https://rabbit-shocker.org"><strong>Rabbit</strong></a> を利用して英語で行う予定でしたが、LTはとくに
うちあわせのために資料を先に出すとかなかったのでとりあえず日本語で作成しました。
実装おわっていないというか実装に時間掛けすぎたのと、RubyKaigiへ持っていくPCをあたらしくしたので
冒険はできずに素直に <a href="https://docs.google.com/presentation"><strong>Google スライド</strong></a> 利用して作成、
後日 <strong>Rabbit</strong> で清書するということにしました。</p>

<p>発表資料自体は 5/8 or 5/9 ぐらいに作成し終っていました。デモなしで発表練習するとちょうど時間通りに
おわるのでこの資料作成完了時点ではこれでよしとしてました。
この時点でも資料はすくたなくとも英語にしようとは考えて資料は作成していました。</p>

<h2 id="当日">当日</h2>

<p>当日の朝、資料作成というか資料の英語変換をやっていて、やっているうちに
実際発表してなにができてなにができてないみたいなこと言ったとしても
なにがなんだかわからんよなとなったので急遽デモをやって、実行できること示すように少し変更しました。</p>

<p>当日はセッションききながらかなり緊張していました、直前のセッションのトラブルもあったので。
聞いた人はわかるとおもうのですが、発表が途中でおわったのはこういった事情があったのでああいう発表になりました。</p>

<h2 id="後日">後日</h2>

<p>発表当日の昼飯時に、 <a href="https://twitter.com/ukstudio">@ukstudio</a> が <a href="https://cookpad.com"><strong>cookpad</strong></a> のイベントとして <a href="https://cookpad.connpass.com/event/282436/"><strong>手を動かして振り返る RubyKaigi 2023</strong></a> が5/18にあるからきてよと誘われたのでいくことにしました。
この会では、デキテイナカったデモを最後までやりきっています。</p>

<h2 id="書き直し">書き直し</h2>

<p><strong>手を動かして~</strong> のあとに <strong>Rabbit</strong> への清書を行ないました。
いままでもいくつかの発表は <strong>Rabbit</strong> でやってたのですが、
<strong>Rabbit テーマ</strong> を作りたい作りたいと思っていたので今回は時間もあるのでつくることにしました。
とはいってもほぼ <a href="https://twitter.com/yu_suke1994">@yu_suke1994</a> の<a href="https://github.com/unasuke/rubykaigi-2023/">リポジトリ</a>をコピーしただけなんでうが……</p>

<h2 id="まとめ">まとめ</h2>

<p><strong>RubyKaigi</strong> の <em>LT</em> で話ししたことをまとめました。
実装の話はもうちょっと詳しく書きたいけど、そもそも実装もすすめたいしでなかなか書けていないですね。</p>

<p>次回作もご期待ください 完</p>

<hr />
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:cfp" role="doc-endnote">
      <p>Call For Proposal。ずっと Call For Paper だとおもってたので知ったときえってなった。 <a href="#fnref:cfp" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:cfpdate" role="doc-endnote">
      <p><a href="https://cfp.rubykaigi.org/events/2023">2023-01-31</a> 締切で完全にネタない状態だった。 <a href="#fnref:cfpdate" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:yoteigai" role="doc-endnote">
      <p>もともとの発表予定ではここまでしかできなかったんですよーって濁す予定でしたが思っている以上に実装がすすんでしまった。 <a href="#fnref:yoteigai" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <h1><a href="/blog/2023/05/15/ruby-kaigi-2023-at-matsumoto/">RubyKaigi2023 @MATZ本</a></h1>
  <p class="author">
    <span class="date">2023-05-15 23:59:59 +0900</span>
  </p>
  <div class="content">
    <p>行ってきたのでまとめます。LT やったのですが、 LT の話はまた今度。</p>

<h2 id="day--1">Day -1</h2>

<p>前日は恒例の <a href="https://asakusarb.esa.io">Asakusa.rb</a> の <a href="https://asakusarb.doorkeeper.jp/events/154786">predrinkup</a> に行ってました。ここでは、 <a href="https://twitter.com/n0kada">nobu</a> とかとはなししたりしてすごしました。
drinkup は次の日のため終了後すぐさま帰宅し、就寝した。</p>

<h2 id="day-0">Day 0</h2>
<p>この日は、 <a href="https://cookpad.connpass.com/event/277569/">RubyistsOnRails</a> というすばらしいイベント列車があったのでノータイム <sup id="fnref:sonnnakotohanai" role="doc-noteref"><a href="#fn:sonnnakotohanai" class="footnote" rel="footnote">1</a></sup> 8時の会に参加申し込み。6時に起床し、7時に出発。
会ではRubyistと話しながら、山見ながら、松本に到着。
松本に到着後飯として <a href="https://tabelog.com/nagano/A2002/A200201/20000092/">みよ田</a> という蕎麦屋に直行。
蕎麦を食べた直後、松本城へ。松本城では <a href="https://twitter.com/yukihiro_matz/">まつもとさん</a> 集団を見つけたので、みんなで Matz本城 背景に記念撮影。まつもとさん一行は開発者会議があったらしく記念撮影後すぐにわかれました。
われわれは、この記念撮影後松本城観光し、もう一軒蕎麦屋へ昼食へ。二軒目の蕎麦屋は <a href="https://tabelog.com/nagano/A2002/A200201/20002376/">蕎麦倶楽部佐々木</a> へ。</p>

<p>そんなことしてたら宿がチェックイン可能になったので、荷物置くのと下着類を購入しひとやすみ(10min程)。</p>

<p>Day 0 最大のイベント、 <a href="https://keebkaigi.org/2023/">KeebKaigi</a> へ!ここで豪華ノベリティを大量に頂きました!!!1とくによいのが城キーキャップで松本城を3DプリントしたISO エンターキーを頂きました。しかしながらこのキー差すキーボードがないので知人に譲る予定です。</p>

<p>KeebKaigi 自体もたいへん面白い Kaigi で楽しめました。とくに、 t-code の紹介のLT、頭文字Vなどよかったです。
KeebKaigi 後は懇親会には参加せず、友人とかるく夕飯をして宿へ。</p>

<h2 id="day-1">Day 1</h2>

<p>ここまででも大変楽しいものでしたが、<a href="https://rubykaigi.org/2023/">RubyKaigi本番</a> はこの日から。</p>

<p>1日目の朝食は会場行く途中でもともと聞いていた店の <a href="https://sioribi.jp/">栞日</a> さんへ。
会場開いて登録したあとノベリティの列をみてげんなりしてたので一旦スポンサーブースをうろうろしてた。
この日聞いたセッションは以下です。</p>

<h3 id="matz-keynote"><a href="https://rubykaigi.org/2023/presentations/yukihiro_matz.html#day1">Matz Keynote</a></h3>

<p>毎年恒例 Matz のキーノート。</p>

<h3 id="昼飯">昼飯</h3>
<p>ランチはたまたま居合わせた6人で <a href="https://tabelog.com/nagano/A2002/A200201/20000098/">おきな堂</a> へ。名物のボルガライスとリンゴジュースを。シードルがあったので一緒にいったひとへオススメしてたりした。</p>

<h3 id="the-future-vision-of-ruby-parser"><a href="https://rubykaigi.org/2023/presentations/spikeolaf.html#day1">The future vision of Ruby Parser</a></h3>

<p>コミッターの <a href="https://twitter.com/spikeolaf">spikelaf</a> さんによるパーサーの開発話。魔窟じゃないよーなんかいってまいましたが、難しい問題を丁寧にひとつひとつ倒していった話をしていました。</p>

<h3 id="make-regexpmatch-much-faster"><a href="https://rubykaigi.org/2023/presentations/makenowjust.html#day1">Make Regexp#match much faster</a></h3>

<p>去年 <a href="https://www.ruby-lang.org/ja/news/2023/03/30/redos-in-time-cve-2023-28756/">ReDoS</a> の対応をしたコミッターの発表。正規表現の可能性を話してくれています。</p>

<h3 id="high-performance-real-time-3d-graphics-with-vulkan"><a href="https://rubykaigi.org/2023/presentations/fredolinhares.html#day1">High-performance real-time 3D graphics with Vulkan</a></h3>

<p><a href="https://www.vulkan.org/">Valkan</a> を Ruby で利用できるようにした話。このあたりは LT への緊張感でほとんど覚えていないです。</p>

<h3 id="power-up-your-repl-life-with-types"><a href="https://rubykaigi.org/2023/presentations/tompng.html#day1">Power up your REPL life with types</a></h3>

<p>去年の <a href="https://github.com/tric/trick2022/blob/master/01-tompng/entry.rb">TRICK Winner</a> で今回の話は <code class="language-plaintext highlighter-rouge">irb</code> を利用しているときにどういう感じで補完が出るのか、出すためにどのような型推論を行なっているのかの話だったとおもう。</p>

<h3 id="lt">LT</h3>

<p>しゃべった</p>

<h3 id="オフィシャルパーティー">オフィシャルパーティー</h3>

<p>つかれたのでそこそこで帰った</p>

<h2 id="day-2">Day 2</h2>

<p>朝飯は <a href="https://tabelog.com/nagano/A2002/A200201/20020720/">珈琲茶房かめのや</a> へ。ここもワンオペで配膳されるまで少し時間がかかった。というか、朝食べくるひといないのかどこもワンオペだったので Day 3 も早めに出るようにしようとなった。</p>

<h3 id="on-ruby-and-ꝩduя-or-how-scary-are-trojan-source-attacks"><a href="https://rubykaigi.org/2023/presentations/duerst.html#day2">On Ruby and ꝩduЯ, or How Scary are Trojan Source Attacks</a></h3>

<p>昔他の言語で話題になった Ruby のコード的には正しいが、見た目ではわからない
不正な文字が入ったときの対策のはなしでした。</p>

<h3 id="build-a-mini-ruby-debugger-in-under-300-lines"><a href="https://rubykaigi.org/2023/presentations/_st0012.html#day2">Build a mini Ruby debugger in under 300 lines</a></h3>

<p>300 行といったなあれは嘘だ。という話。Ruby の Debugger を200 行くらいでつくったはなしでした。</p>

<h3 id="昼飯-1">昼飯</h3>

<p><a href="https://tabelog.com/nagano/A2002/A200201/20015852/">種村</a> で蕎麦と岩魚と日本酒。</p>

<h3 id="revisiting-typeprof---ide-support-as-a-primary-feature"><a href="https://rubykaigi.org/2023/presentations/mametter.html#day2">Revisiting TypeProf - IDE support as a primary feature</a></h3>

<p>Ruby に梱包されている <a href="https://github.com/ruby/typeprof/blob/master/doc/doc.ja.md"><code class="language-plaintext highlighter-rouge">TypeProf</code></a> が遅いので速くして、また書いている途中でもエラーがでたときどうするかとかの説明をしていました。まだ利用できていないので試したくなるものだった。</p>

<h3 id="ruby-implementation-of-quic-progress-and-challenges"><a href="https://rubykaigi.org/2023/presentations/yu_suke1994.html#day2">Ruby Implementation of QUIC: Progress and Challenges</a></h3>

<p><a href="https://twitter.com/yu_suke1994">Unasuke</a> 大先生のライフワーク、 Ruby の <a href="https://datatracker.ietf.org/doc/html/rfc9000">QUIC</a> 対応のはなし。Python での実装はどうとかのはなしで今回は実装がすすんでいるようでよかった。とはいえ道程はまだまだかかりそう。</p>

<h3 id="afternoon-break">afternoon break</h3>

<p>お昼休憩後は Jeremy Evans や Maxime の話を聞いていたが疲れてなにも覚えていない。</p>

<h3 id="leaner-drinkup-at-rubykaigi-2023"><a href="https://leanertechnologies.connpass.com/event/280191/">Leaner Drinkup at RubyKaigi 2023</a></h3>

<p>この日は <a href="https://leaner.jp/">Leaner</a> さん主催の drinkup へ行きました。ここでは主に日本を飲んですごしました。でここで、spikelaf が kaigi でも話してた <a href="https://github.com/ruby/lrama">lrama</a> が Ruby 本体のとりこまれ、 <a href="https://www.ruby-lang.org/ja/news/2023/05/12/ruby-3-3-0-preview1-released/">Ruby 3.3.0-preview1 がリリースされました</a>!なんかさわいでるなと思たらリリース作業シテイタトハ…
drinkup 終了後は <a href="https://twitter.com/onk">onk</a> とふたりで近所のワインバーへ行き、軽くのんで宿へ帰りました。</p>

<p>宿帰ったら <a href="https://esm.co.jp/">ESM</a> さんのノベリティの <a href="https://blog.agile.esm.co.jp/entry/ruby-method-karuta">Rubyメソッドかるた</a> でみんなでわいわいしながら遊んでました。</p>

<h2 id="day-3">Day 3</h2>

<p>この日の朝食は <a href="https://tabelog.com/nagano/A2002/A200201/20023046">山山食堂</a> というところでしました。</p>

<h3 id="committers-and-the-worldのあと">Committers and the Worldのあと</h3>

<p>今回は Matz本 ということで会場にいる「まつもとさん」一同会して写真を撮ることを目的としてあつめてました。写真は以下になります</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">松本さん大集合に、当社の松本さんも混ぜていただきありがとうございましたっ🏯<a href="https://twitter.com/hashtag/RubyKaigi2023?src=hash&amp;ref_src=twsrc%5Etfw">#RubyKaigi2023</a> <a href="https://t.co/neYYer5e2A">pic.twitter.com/neYYer5e2A</a></p>&mdash; Yasunori Suzuki (@yasuzukisan) <a href="https://twitter.com/yasuzukisan/status/1657253330056519680?ref_src=twsrc%5Etfw">May 13, 2023</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<h3 id="ruby--adbc---a-single-api-between-ruby-and-dbs"><a href="https://rubykaigi.org/2023/presentations/ktou.html#day3">Ruby + ADBC - A single API between Ruby and DBs</a></h3>

<p><a href="https://github.com/kou">須藤さん</a> の発表で、 <a href="https://arrow.apache.org/docs/format/ADBC.html"><code class="language-plaintext highlighter-rouge">ADBC</code></a> で DB へ接続し、さらのその接続からのよみかきの高速化のはなしでした。あいかわらずすごいなと思いながら聞いていました。</p>

<h3 id="ruby-jit-hacking-guide"><a href="https://rubykaigi.org/2023/presentations/k0kubun.html#day3">Ruby JIT Hacking Guide</a></h3>

<p><a href="https://github.com/k0kubun">国分さん</a> の新作 <a href="https://github.com/ruby/ruby/pull/7448">RubyJIT</a>。PRみた感じだとやってるネタにてるなあとおもってたけど、アプローチがすこし違い、またこちらは直接ELFを書いているようなのでまだちがうようだ。とはいえ今やっていることは似ているのであとで参考にしよう。</p>

<h3 id="after-party-and-music-mixin">After Party and Music Mixin</h3>

<p><a href="https://stores.jp/">STORESさん</a> の <a href="https://hey.connpass.com/event/277763/">アフターパティー</a> と <a href="https://www.pixiv.net">pixivさん</a> の <a href="https://conference.pixiv.co.jp/2023/rubymusicmixin">ruby music mixin</a> にいってきました。両方ともサイコーでした!!!!</p>

<h2 id="day-4">Day 4</h2>

<p>一人で野沢温泉村いって温泉はいって、ジンのんで、ビールのみいこうと一旦山おりたら温泉にしか飲むとこなかったのでもどったりして帰りました。</p>

<h2 id="おわり">おわり</h2>

<p>今回のRubyKaigi久しぶりのFull開催で大変楽しめたのですが、LTとは言えはじめての発表があり、心から楽しめたかというとあれですが、すごく楽しかったし、刺激になりました。来年の那覇は本編に出せるようになんとか精進します!!!</p>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:sonnnakotohanai" role="doc-endnote">
      <p>海外の人が登録して行ったほうがいいんじゃないかと一瞬思った <a href="#fnref:sonnnakotohanai" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <h1><a href="/blog/2023/03/21/my-hobby-is-building-vaporware/">趣味は vaporware 造りですv0.0.0</a></h1>
  <p class="author">
    <span class="date">2023-03-21 13:59:59 +0900</span>
  </p>
  <div class="content">
    <p>プログラマー三大勉強はしたけど、実装はしたことないものといえば
CPU、OS、コンパイラーなのです<sup id="fnref:kojinsa" role="doc-noteref"><a href="#fn:kojinsa" class="footnote" rel="footnote">1</a></sup>が、先日 <a href="https://www.publickey1.jp/blog/23/ruby30static_compiler_for_ruby.html">ruby30th 誕生日会のキーノート</a>で
matz が “Static Compiler for Ruby” という今はまだない <code class="language-plaintext highlighter-rouge">vaporware</code> として
挙げていたのでこの <strong>static compiler</strong> を作ろうとなりました。</p>

<p><a href="https://github.com/katsyoshi/vaporware"><img src="https://gh-card.dev/repos/katsyoshi/vaporware.svg" alt="katsyoshi/vaporware - GitHub" /></a></p>

<h2 id="goal">Goal</h2>

<p><strong>Ruby</strong> のコードを <strong>static compile</strong> できるようにする。</p>

<p>コンパイル先のターゲットは <strong>x86</strong> とします。 <strong>ARM</strong> や <strong>RISC-V</strong> などは今回の実装ではターゲットにしないです。</p>

<p>とはいえすべての <strong>Ruby</strong> の機能を実装すると時間がかかりすぎるので個人で無理のない範囲
で作ろうとします。無理のない実装範囲は以下なのかなと</p>

<ol>
  <li>四則演算</li>
  <li>変数</li>
  <li>メソッド</li>
  <li>制御構文</li>
  <li>プリミティブ型</li>
</ol>

<p>この5つの機能を実装する予定です。</p>

<h3 id="実現する機能以外のことについて">実現する機能以外のことについて</h3>

<p>5つの機能を実現すること以上のことはやらない予定です。
やらないこととしては <em>最適化</em> 、 <em>GC</em> 、 外部ファイルで定義したメソッドやクラスの読み込みは実装しない予定です。
実装しない個人的意見を以下に書いていきます。</p>

<p>最適化は <strong>Ruby</strong> のコードを単純に <em>機械語</em> におとしただけでは現在の <strong>RubyVM</strong>
より速くならないと考えているからです(要確認)。
<strong>LLVM IR</strong> などへの変換ではなく、 <em>機械語</em> なのは <strong>LLVM</strong> をインストールする必要があるなどして
面倒なのが大きいです<sup id="fnref:gentoo" role="doc-noteref"><a href="#fn:gentoo" class="footnote" rel="footnote">2</a></sup>。あとバージョン毎に <strong>LLVM IR</strong> が異なるのも現状では対応しにくい点となっています。</p>

<p><em>GC</em> (Garbage Collection: ガベージコレクション) についてはそもそもクラスをサポートできない、
変数などのメモリを確保しておく時間が長いプログラムを対象としないので今回はスコープ外としています。</p>

<p>外部ファイル読み込みについてですが、外部ファイルの読み込みして <em>コンパイル</em> するだけなら
そこまで問題にはならないと考えていますが、外部ファイルで定義された <em>メソッド</em> や <em>クラス</em> を
事前に <em>コンパイル</em> して最後に <em>リンク</em> するのは型が不定になるのでサポートするのは難しいと考えています。</p>

<h2 id="実装方針">実装方針</h2>
<p>Goal までの実装は <a href="https://www.sigbus.info/compilerbook">低レイヤを知りたい人のためのCコンパイラ作成入門</a> を参考にすすめていきます。
最初に <em>コンパイラー</em> を実装するものとして <em>C 言語</em> がたぶん勉強してきてうかぶと思います<sup id="fnref:java" role="doc-noteref"><a href="#fn:java" class="footnote" rel="footnote">3</a></sup>。
<em>C 言語</em> だと <em>機械語</em> や <em>VM</em> のバイトコードへ落とすことのできる資料が多いので選択しています。
とは言っても <strong>Ruby</strong> からの脳内変換はある程度必要なので慣れているというのもあります。</p>

<p>実装としては <em>AST</em>(Abstract Syntax Tree: 構文抽象木) から愚直に <strong>x86 アセンブラ</strong> をファイルへ書き出し、
そこから <em>C コンパイラー</em> (<code class="language-plaintext highlighter-rouge">gcc</code> or <code class="language-plaintext highlighter-rouge">clang</code>) をつかって機械語へ <em>コンパイル</em> します。
フルフルの <strong>Ruby</strong> を実装するわけじゃないので依存する <strong>gem</strong> の依存も極力減らしたいです。</p>

<h3 id="実装環境">実装環境</h3>

<ul>
  <li>CPU: Ryzen Thread Ripper 1950x</li>
  <li>gcc: 12.2.1</li>
  <li>clang: 16.0.0</li>
  <li>OS: Gentoo Linux</li>
  <li>Linux Kernel: 6.2 系</li>
</ul>

<h2 id="パーサー">パーサー</h2>

<p>まず、<em>AST</em> を得るために <em>パーサー</em> が必要なのですが、 <strong>Ruby</strong> の構文は複雑なのでここは頑張らないようにします。ここをどうやって解決するのかというと <code class="language-plaintext highlighter-rouge">RubyVM::AbstractSyntaxTree</code> や <code class="language-plaintext highlighter-rouge">Ripper</code> をつかうのか、<code class="language-plaintext highlighter-rouge">parser.gem</code> をつかうのかを決めるひつようがあります。今回というかしばらくは <code class="language-plaintext highlighter-rouge">parser.gem</code> を利用して <em>AST</em> を得ることにします。
ゆくゆくは <code class="language-plaintext highlighter-rouge">RubyVM::AbstractSyntaxTree</code> への置き替えはするよていです。</p>

<p>ここはそのまま <code class="language-plaintext highlighter-rouge">parser.gem</code> のチュートリアルどおりにすれば <em>AST</em> が得られます。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"parser/current"</span>

<span class="nb">puts</span> <span class="no">Parser</span><span class="o">::</span><span class="no">CurrentRuby</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s2">"(1 + 2) * 3 / (5 - 4)"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="きょうはここまで">きょうはここまで</h2>

<p>とりあえず手を動かしはじめましたが、ななななんと、似たような機能が実は <strong>Ruby 3.3</strong> 向けに
<em>JIT</em> として入ったようです<sup id="fnref:rjit" role="doc-noteref"><a href="#fn:rjit" class="footnote" rel="footnote">4</a></sup>。
ということでねこの話はね、勉強の話しかないんですが一旦 Goal まで作ってみましょうね。</p>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:kojinsa" role="doc-endnote">
      <p>個人差があります。 <a href="#fnref:kojinsa" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:gentoo" role="doc-endnote">
      <p>Gentoo Linux 使っているので毎回コンパイルしているので本当にめんどう。バイナリあるよとかそういう正論は受け付けていないです。 <a href="#fnref:gentoo" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:java" role="doc-endnote">
      <p>時代によって変わるかも。<strong>Java</strong> だったり、<strong>Lisp</strong> だったりする人がいるかも。 <a href="#fnref:java" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:rjit" role="doc-endnote">
      <p>https://github.com/ruby/ruby/pull/7448 <a href="#fnref:rjit" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <h1><a href="/blog/2023/01/03/upgrade-gems-using-rust-for-new-rubygems/">Update rubygems using Rust for Ruby 3.2</a></h1>
  <p class="author">
    <span class="date">2023-01-03 23:59:59 +0900</span>
  </p>
  <div class="content">
    <p><a href="/blog/2022/08/12/how-to-use-rust-in-ruby-gems/">以前このブログ</a>で <a href="https://www.rust-lang.org/"><strong>Rust</strong></a> を利用して <a href="https://rubygems.org"><strong>rubygems</strong></a> を作成した
<a href="https://github.com/katsyoshi/rust_uuid"><strong>rust_uuid</strong></a> が <a href="https://www.ruby-lang.org/ja/news/2022/12/25/ruby-3-2-0-released/"><strong>Ruby 3.2</strong> がリリース</a> によりコンパイルできなくなったのでその修正顛末。</p>

<h2 id="環境">環境</h2>

<table>
  <thead>
    <tr>
      <th>system</th>
      <th>failed version</th>
      <th>succeed version</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ruby</td>
      <td>3.2.0</td>
      <td>3.2.0</td>
    </tr>
    <tr>
      <td>gem</td>
      <td>3.4.1</td>
      <td>3.4.2</td>
    </tr>
    <tr>
      <td>bundler</td>
      <td>2.3.19</td>
      <td>2.4.2</td>
    </tr>
    <tr>
      <td>rb-sys</td>
      <td>0.9.29</td>
      <td>0.9.53</td>
    </tr>
    <tr>
      <td>magnus</td>
      <td>0.3.2</td>
      <td>0.4.4</td>
    </tr>
  </tbody>
</table>

<h2 id="whats-happened">what’s happened?</h2>

<p><strong>Ruby 3.2</strong> が出てたのでアップデートして試してみるかーとおもいコマンドを実行!!!!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bundle <span class="nb">exec </span>rake build
<span class="nb">.</span>
<span class="nb">.</span>
...
error[E0425]: cannot find value <span class="sb">`</span>RUBY_ABI_VERSION<span class="sb">`</span> <span class="k">in </span>the crate root
  <span class="nt">--</span><span class="o">&gt;</span> /path/to/cargo/dir/registry/src/github.com-1ecc6299db9ec823/rb-sys-0.9.29/src/ruby_abi_version.rs:14:73
   |
14 | pub const __RB_SYS_RUBY_ABI_VERSION: std::os::raw::c_ulonglong <span class="o">=</span> crate::RUBY_ABI_VERSION as _<span class="p">;</span>
   |                                                                         ^^^^^^^^^^^^^^^^ not found <span class="k">in </span>the crate root

For more information about this error, try <span class="sb">`</span>rustc <span class="nt">--explain</span> E0425<span class="sb">`</span><span class="nb">.</span>
error: could not compile <span class="sb">`</span>rb-sys<span class="sb">`</span> due to previous error
warning: build failed, waiting <span class="k">for </span>other <span class="nb">jobs </span>to finish...
gmake: <span class="k">***</span> <span class="o">[</span>Makefile:564: target/release/librust_uuid.so] エラー 101
rake aborted!
Command failed with status <span class="o">(</span>2<span class="o">)</span>: <span class="o">[</span>/usr/bin/gmake...]
/path/to/rbenv/versions/3.2.0/bin/bundle:25:in <span class="sb">`</span>load<span class="s1">'
/path/to/rbenv/versions/3.2.0/bin/bundle:25:in `&lt;main&gt;'</span>
Tasks: TOP <span class="o">=&gt;</span> build <span class="o">=&gt;</span> compile <span class="o">=&gt;</span> compile:x86_64-linux <span class="o">=&gt;</span> compile:rust_uuid:x86_64-linux <span class="o">=&gt;</span> copy:rust_uuid:x86_64-linux:3.2.0 <span class="o">=&gt;</span> tmp/x86_64-linux/rust_uuid/3.2.0/rust_uuid.so
<span class="o">(</span>See full trace by running task with <span class="nt">--trace</span><span class="o">)</span>
bundle <span class="nb">exec </span>rake build  63.55s user 10.61s system 541% cpu 13.705 total
</code></pre></div></div>

<p>おーなるほどなるほど、 <strong>cargo</strong> の <a href="https://github.com/oxidize-rb/rb-sys"><strong>rb-sys</strong></a> が <strong>Ruby 3.2</strong> に対応していないバージョンつかってるんだなと理解。<strong>cargo</strong> を更新っするぞい。</p>

<h2 id="うpだて-cargo-ぱっけーじ">うpだて <strong>cargo</strong> ぱっけーじ</h2>

<p>ということで <code class="language-plaintext highlighter-rouge">cargo build</code> が通るようにパッケージを更新するぞい。
<strong>cargo</strong> も <strong>bundler</strong> 同様、 <code class="language-plaintext highlighter-rouge">cargo update</code> でいい感じにアップデートしてくれます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd </span>ext/rust_uuid
<span class="nv">$ </span>cargo update
<span class="nv">$ </span>cargo build
   Compiling magnus v0.3.2
error[E0432]: unresolved import <span class="sb">`</span>crate::ruby_sys::ruby_rstring_consts<span class="sb">`</span>
  <span class="nt">--</span><span class="o">&gt;</span> /path/to/cargo/dir/registry/src/github.com-1ecc6299db9ec823/magnus-0.3.2/src/r_string.rs:23:47
   |
23 | use crate::ruby_sys::<span class="o">{</span>rb_str_to_interned_str, ruby_rstring_consts::RSTRING_EMBED_LEN_SHIFT<span class="o">}</span><span class="p">;</span>
   |                                               ^^^^^^^^^^^^^^^^^^^ could not find <span class="sb">`</span>ruby_rstring_consts<span class="sb">`</span> <span class="k">in</span> <span class="sb">`</span>ruby_sys<span class="sb">`</span>

error[E0599]: no variant or associated item named <span class="sb">`</span>RSTRING_EMBED_LEN_MASK<span class="sb">`</span> found <span class="k">for </span>enum <span class="sb">`</span>ruby_rstring_flags<span class="sb">`</span> <span class="k">in </span>the current scope
   <span class="nt">--</span><span class="o">&gt;</span> /path/to/cargo/dir/registry/src/github.com-1ecc6299db9ec823/magnus-0.3.2/src/r_string.rs:368:38
    |
368 |             f &amp;<span class="o">=</span> ruby_rstring_flags::RSTRING_EMBED_LEN_MASK as VALUE<span class="p">;</span>
    |                                      ^^^^^^^^^^^^^^^^^^^^^^ variant or associated item not found <span class="k">in</span> <span class="sb">`</span>ruby_rstring_flags<span class="sb">`</span>

error[E0599]: no variant or associated item named <span class="sb">`</span>RSTRING_EMBED_LEN_MASK<span class="sb">`</span> found <span class="k">for </span>enum <span class="sb">`</span>ruby_rstring_flags<span class="sb">`</span> <span class="k">in </span>the current scope
   <span class="nt">--</span><span class="o">&gt;</span> /path/to/cargo/dir/registry/src/github.com-1ecc6299db9ec823/magnus-0.3.2/src/r_string.rs:968:42
    |
968 |                 f &amp;<span class="o">=</span> ruby_rstring_flags::RSTRING_EMBED_LEN_MASK as VALUE<span class="p">;</span>
    |                                          ^^^^^^^^^^^^^^^^^^^^^^ variant or associated item not found <span class="k">in</span> <span class="sb">`</span>ruby_rstring_flags<span class="sb">`</span>

Some errors have detailed explanations: E0432, E0599.
For more information about an error, try <span class="sb">`</span>rustc <span class="nt">--explain</span> E0432<span class="sb">`</span><span class="nb">.</span>
error: could not compile <span class="sb">`</span>magnus<span class="sb">`</span> due to 3 previous errors
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">cargo update</code> しましたが、やっぱり駄目でしたね。今度は <a href="https://github.com/matsadler/magnus"><strong>magnus</strong></a> が駄目そう。
<code class="language-plaintext highlighter-rouge">Cargo.toml</code> を見てみると、 <code class="language-plaintext highlighter-rouge">magnus = { version = "0.3", features = ["rb-sys-interop"] }</code> と指定してあり、 version 0.3 系が駄目そうということが類推されます。ということで公式ページを見ると新しいバージョンが出ているのでこちらにします。</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">--- a/ext/rust_uuid/Cargo.toml
</span><span class="gi">+++ b/ext/rust_uuid/Cargo.toml
</span><span class="p">@@ -10,7 +10,7 @@</span> crate-type = ["cdylib"]
 [dependencies]
 rb-sys = "0.9"
 rb-allocator = "0.9"
<span class="gd">-magnus = { version = "0.3", features = ["rb-sys-interop"] }
</span><span class="gi">+magnus = { version = "0.4", features = ["rb-sys-interop"] }
</span><span class="err">
</span> [dependencies.uuid]
 version = "1.1.2"
</code></pre></div></div>

<p>再度ビルド!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>cargo update
<span class="nv">$ </span>cargo build
   Compiling rust_uuid v0.1.0 <span class="o">(</span>/home/katsyoshi/Program/Ruby/rust_uuid/ext/rust_uuid<span class="o">)</span>
    Finished dev <span class="o">[</span>unoptimized + debuginfo] target<span class="o">(</span>s<span class="o">)</span> <span class="k">in </span>0.18s
</code></pre></div></div>

<p>おおっ通りました!やったね!</p>

<h2 id="build">build</h2>

<p>ということ <code class="language-plaintext highlighter-rouge">cargo build</code> 通ったので <code class="language-plaintext highlighter-rouge">gem install</code> しましよう。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> /path/to/rust_uuid
<span class="nv">$ </span>bundle <span class="nb">exec </span>rake build
<span class="nb">cd </span>tmp/x86_64-linux/rust_uuid/3.2.0
/usr/bin/gmake
generating target/release/librust_uuid.so <span class="o">(</span>release<span class="o">)</span>
cargo rustc <span class="nt">--target-dir</span> target <span class="nt">--manifest-path</span> ../../../../ext/rust_uuid/Cargo.toml <span class="nt">--lib</span> <span class="nt">--release</span> <span class="nt">--</span> <span class="nt">-C</span> <span class="nv">linker</span><span class="o">=</span>gcc <span class="nt">-L</span> <span class="nv">native</span><span class="o">=</span>/path/to/rbenv/versions/3.2.0/lib <span class="nt">-L</span> <span class="nv">native</span><span class="o">=</span>/path/to/rbenv/versions/3.2.0/lib <span class="nt">-L</span> <span class="nv">native</span><span class="o">=</span>/home/katsyoshi/.local/lib:-L/home/katsyoshi/.local/lib: <span class="nt">-C</span> link-arg<span class="o">=</span><span class="nt">-lm</span> <span class="nt">-l</span> pthread
   Compiling libc v0.2.139
   Compiling proc-macro2 v1.0.49
   Compiling quote v1.0.23
   Compiling unicode-ident v1.0.6
   Compiling clang-sys v1.4.0
   Compiling regex-syntax v0.6.28
   Compiling syn v1.0.107
   Compiling rb-sys-env v0.1.1
   Compiling libloading v0.7.4
   Compiling nom v7.1.2
   Compiling aho-corasick v0.7.20
   Compiling magnus v0.4.4
   Compiling bindgen v0.60.1
   Compiling getrandom v0.2.8
   Compiling uuid v1.2.2
   Compiling cexpr v0.6.0
   Compiling regex v1.7.0
   Compiling magnus-macros v0.3.0
   Compiling rb-sys-build v0.9.53
   Compiling rb-sys v0.9.53
   Compiling rb-allocator v0.9.6
   Compiling rust_uuid v0.1.0 <span class="o">(</span>/path/to/rust_uuid/ext/rust_uuid<span class="o">)</span>
    Finished release <span class="o">[</span>optimized] target<span class="o">(</span>s<span class="o">)</span> <span class="k">in </span>12.03s
<span class="nb">cd</span> -
<span class="nb">mkdir</span> <span class="nt">-p</span> tmp/x86_64-linux/stage/lib/rust_uuid
/usr/bin/gmake <span class="nb">install </span><span class="nv">target_prefix</span><span class="o">=</span>
generating target/release/librust_uuid.so <span class="o">(</span>release<span class="o">)</span>
cargo rustc <span class="nt">--target-dir</span> target <span class="nt">--manifest-path</span> ../../../../ext/rust_uuid/Cargo.toml <span class="nt">--lib</span> <span class="nt">--release</span> <span class="nt">--</span> <span class="nt">-C</span> <span class="nv">linker</span><span class="o">=</span>gcc <span class="nt">-L</span> <span class="nv">native</span><span class="o">=</span>/path/to/rbenv/versions/3.2.0/lib <span class="nt">-L</span> <span class="nv">native</span><span class="o">=</span>/path/to/rbenv/versions/3.2.0/lib <span class="nt">-L</span> <span class="nv">native</span><span class="o">=</span>/home/katsyoshi/.local/lib:-L/home/katsyoshi/.local/lib: <span class="nt">-C</span> link-arg<span class="o">=</span><span class="nt">-lm</span> <span class="nt">-l</span> pthread
    Finished release <span class="o">[</span>optimized] target<span class="o">(</span>s<span class="o">)</span> <span class="k">in </span>0.02s
installing rust_uuid.so to /path/to/rust_uuid/lib/rust_uuid
/usr/bin/install <span class="nt">-c</span> <span class="nt">-m</span> 0755 rust_uuid.so /path/to/rust_uuid/lib/rust_uuid
<span class="nb">cp </span>tmp/x86_64-linux/rust_uuid/3.2.0/rust_uuid.so tmp/x86_64-linux/stage/lib/rust_uuid/rust_uuid.so
rake aborted!
Running <span class="sb">`</span>gem build <span class="nt">-V</span> /path/to/rust_uuid/rust_uuid.gemspec<span class="sb">`</span> failed with the following output:

WARNING:  description and summary are identical
WARNING:  open-ended dependency on benchmark-ips <span class="o">(&gt;=</span> 0, development<span class="o">)</span> is not recommended
  use a bounded requirement, such as <span class="s1">'~&gt; x.y'</span>
WARNING:  open-ended dependency on rake <span class="o">(&gt;=</span> 13.0.0, development<span class="o">)</span> is not recommended
  <span class="k">if </span>rake is semantically versioned, use:
    add_development_dependency <span class="s1">'rake'</span>, <span class="s1">'~&gt; 13.0'</span>, <span class="s1">'&gt;= 13.0.0'</span>
WARNING:  open-ended dependency on rake-compiler <span class="o">(&gt;=</span> 0, development<span class="o">)</span> is not recommended
  use a bounded requirement, such as <span class="s1">'~&gt; x.y'</span>
WARNING:  open-ended dependency on rb_sys <span class="o">(&gt;=</span> 0, development<span class="o">)</span> is not recommended
  use a bounded requirement, such as <span class="s1">'~&gt; x.y'</span>
WARNING:  open-ended dependency on rspec <span class="o">(&gt;=</span> 0, development<span class="o">)</span> is not recommended
  use a bounded requirement, such as <span class="s1">'~&gt; x.y'</span>
WARNING:  See https://guides.rubygems.org/specification-reference/ <span class="k">for </span><span class="nb">help
</span>ERROR:  While executing gem ... <span class="o">(</span>Gem::InvalidSpecificationException<span class="o">)</span>
    You have specified rust based extension, but Cargo.lock is not part of the gem files. Please run <span class="sb">`</span>cargo generate-lockfile<span class="sb">`</span> or any other <span class="nb">command </span>to generate Cargo.lock and ensure it is added to your gem files section <span class="k">in </span>gemspec.

/path/to/rbenv/versions/3.2.0/bin/bundle:25:in <span class="sb">`</span>load<span class="s1">'
/path/to/rbenv/versions/3.2.0/bin/bundle:25:in `&lt;main&gt;'</span>
Tasks: TOP <span class="o">=&gt;</span> build
<span class="o">(</span>See full trace by running task with <span class="nt">--trace</span><span class="o">)</span>
bundle <span class="nb">exec </span>rake build  32.87s user 4.33s system 291% cpu 12.741 total
</code></pre></div></div>

<p>なるほど？ <code class="language-plaintext highlighter-rouge">Cargo.lock</code> ファイルもあるし問題なさそうだな。よくわからんので <strong>rubygems</strong> のリポジトリでエラーメッセージを探してみます。</p>

<p>すると<a href="https://github.com/rubygems/rubygems/blob/05df95280e5f25299f4130a25dc44100226c2235/lib/rubygems/specification_policy.rb#L467-L474">以下のようなコード</a>が</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">validate_rust_extensions</span><span class="p">(</span><span class="n">builder</span><span class="p">)</span> <span class="c1"># :nodoc:</span>
    <span class="n">rust_extension</span> <span class="o">=</span> <span class="vi">@specification</span><span class="p">.</span><span class="nf">extensions</span><span class="p">.</span><span class="nf">any?</span> <span class="p">{</span><span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">builder</span><span class="p">.</span><span class="nf">builder_for</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="nf">is_a?</span> <span class="no">Gem</span><span class="o">::</span><span class="no">Ext</span><span class="o">::</span><span class="no">CargoBuilder</span> <span class="p">}</span>
    <span class="n">missing_cargo_lock</span> <span class="o">=</span> <span class="o">!</span><span class="vi">@specification</span><span class="p">.</span><span class="nf">files</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="s2">"Cargo.lock"</span><span class="p">)</span>

    <span class="n">error</span> <span class="o">&lt;&lt;-</span><span class="no">ERROR</span> <span class="k">if</span> <span class="n">rust_extension</span> <span class="o">&amp;&amp;</span> <span class="n">missing_cargo_lock</span><span class="sh">
You have specified rust based extension, but Cargo.lock is not part of the gem files. Please run `cargo generate-lockfile` or any other command to generate Cargo.lock and ensure it is added to your gem files section in gemspec.
</span><span class="no">    ERROR</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>なろほどなろほど、プロジェクトの root 直下に置いておく必要があるのね。でもそのファイルどういうものなの？</p>

<h2 id="gem-bundler-update">gem, bundler update</h2>

<p>ってなわけで、今度は正式に <strong>rubygems</strong> で正式にサポートされ、 <strong>bundler</strong> でも <strong>gem</strong> を作成するときにも <code class="language-plaintext highlighter-rouge">bundle gem --ext=rust gem_name</code> で<a href="https://github.com/rubygems/rubygems/pull/6149">スケルトンが作成</a>されるようになりました。ということでこれを利用して <code class="language-plaintext highlighter-rouge">Cargo.toml</code> を作ってみましょう</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bundle gem <span class="nt">--mit</span> <span class="nt">--ext</span><span class="o">=</span>rust gem_name
ERROR: <span class="s2">"bundle gem"</span> was called with arguments <span class="o">[</span><span class="s2">"rust"</span>, <span class="s2">"gem_name"</span><span class="o">]</span>
Usage: <span class="s2">"bundle gem NAME [OPTIONS]"</span>
</code></pre></div></div>

<p>ok, ok, これは <strong>bundler</strong> のバージョンが古いな</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bundle version
Bundler version 2.3.19 <span class="o">(</span>2022-07-27 commit 4f496f93e6<span class="o">)</span>
</code></pre></div></div>

<p>さっきの <strong>PR</strong> は入ったのは <strong>Ruby 3.2</strong> リリース直前なのでまだ入ってないよなとおもったけど、実際は <code class="language-plaintext highlighter-rouge">Gemfile.lock</code> の <code class="language-plaintext highlighter-rouge">BUNDLED WITH</code> が <code class="language-plaintext highlighter-rouge">2.3.19</code> を指定してるだけだったのです。
なので対象の 2 行を削除して <code class="language-plaintext highlighter-rouge">bundle update</code> を実行し、続いて <strong>rust</strong> サポートした <strong>gem</strong> を生成して、 <code class="language-plaintext highlighter-rouge">Cargo.toml</code> を見てみましょう。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bundle gem <span class="nt">--mit</span> <span class="nt">--ext</span><span class="o">=</span>rust gem_name
Creating gem <span class="s1">'gem_name'</span>...
MIT License enabled <span class="k">in </span>config
Changelog enabled <span class="k">in </span>config
Initializing git repo <span class="k">in</span> /path/to/rust_uuid/gem_name
      create  gem_name/Gemfile
      create  gem_name/lib/gem_name.rb
      create  gem_name/lib/gem_name/version.rb
      create  gem_name/sig/gem_name.rbs
      create  gem_name/gem_name.gemspec
      create  gem_name/Rakefile
      create  gem_name/README.md
      create  gem_name/bin/console
      create  gem_name/bin/setup
      create  gem_name/.gitignore
      create  gem_name/.github/workflows/main.yml
      create  gem_name/LICENSE.txt
      create  gem_name/CHANGELOG.md
      create  gem_name/Cargo.toml
      create  gem_name/ext/gem_name/Cargo.toml
      create  gem_name/ext/gem_name/extconf.rb
      create  gem_name/ext/gem_name/src/lib.rs
Gem <span class="s1">'gem_name'</span> was successfully created. For more information on making a RubyGem visit https://bundler.io/guides/creating_gem.html
<span class="nv">$ </span><span class="nb">cat </span>Cargo.toml
<span class="c"># This Cargo.toml is here to let externals tools (IDEs, etc.) know that this is</span>
<span class="c"># a Rust project. Your extensions depedencies should be added to the Cargo.toml</span>
<span class="c"># in the ext/ directory.</span>

<span class="o">[</span>workspace]
members <span class="o">=</span> <span class="o">[</span><span class="s2">"./ext/gem_name"</span><span class="o">]</span>
resolver <span class="o">=</span> <span class="s2">"2"</span>
</code></pre></div></div>

<p>というようなファイルが得られるので真似して作成しちゃいましょう。</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[workspace]</span>
<span class="py">members</span> <span class="p">=</span> <span class="p">[</span><span class="s">"./ext/rust_uuid"</span><span class="p">]</span>
<span class="py">resolver</span> <span class="p">=</span> <span class="s">"2"</span>
</code></pre></div></div>

<p>そうしたらもう一度ビルドしてしまいます!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>cargo generate-lockfile
<span class="nv">$ </span>git add Cargo.toml Carog.lock
<span class="nv">$ </span>bundle <span class="nb">exec </span>rake build
/usr/bin/gmake <span class="nb">install </span><span class="nv">target_prefix</span><span class="o">=</span>
generating target/release/librust_uuid.so <span class="o">(</span>release<span class="o">)</span>
cargo rustc <span class="nt">--target-dir</span> target <span class="nt">--manifest-path</span> ../../../../ext/rust_uuid/Cargo.toml <span class="nt">--lib</span> <span class="nt">--release</span> <span class="nt">--</span> <span class="nt">-C</span> <span class="nv">linker</span><span class="o">=</span>gcc <span class="nt">-L</span> <span class="nv">native</span><span class="o">=</span>/path/to/rbenv/versions/3.2.0/lib <span class="nt">-L</span> <span class="nv">native</span><span class="o">=</span>/path/to/rbenv/versions/3.2.0/lib <span class="nt">-L</span> <span class="nv">native</span><span class="o">=</span>/home/katsyoshi/.local/lib:-L/home/katsyoshi/.local/lib: <span class="nt">-C</span> link-arg<span class="o">=</span><span class="nt">-lm</span> <span class="nt">-l</span> pthread
   Compiling rust_uuid v0.1.0 <span class="o">(</span>/path/to/rust_uuid/ext/rust_uuid<span class="o">)</span>
    Finished release <span class="o">[</span>optimized] target<span class="o">(</span>s<span class="o">)</span> <span class="k">in </span>0.26s
installing rust_uuid.so to /path/to/rust_uuid/lib/rust_uuid
/usr/bin/install <span class="nt">-c</span> <span class="nt">-m</span> 0755 rust_uuid.so /path/to/rust_uuid/lib/rust_uuid
<span class="nb">cp </span>tmp/x86_64-linux/rust_uuid/3.2.0/rust_uuid.so tmp/x86_64-linux/stage/lib/rust_uuid/rust_uuid.so
rust_uuid 0.1.0 built to pkg/rust_uuid-0.1.0.gem.
<span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="nb">install</span>
/usr/bin/gmake <span class="nb">install </span><span class="nv">target_prefix</span><span class="o">=</span>
generating target/release/librust_uuid.so <span class="o">(</span>release<span class="o">)</span>
cargo rustc <span class="nt">--target-dir</span> target <span class="nt">--manifest-path</span> ../../../../ext/rust_uuid/Cargo.toml <span class="nt">--lib</span> <span class="nt">--release</span> <span class="nt">--</span> <span class="nt">-C</span> <span class="nv">linker</span><span class="o">=</span>gcc <span class="nt">-L</span> <span class="nv">native</span><span class="o">=</span>/path/to/rbenv/versions/3.2.0/lib <span class="nt">-L</span> <span class="nv">native</span><span class="o">=</span>/path/to/rbenv/versions/3.2.0/lib <span class="nt">-L</span> <span class="nv">native</span><span class="o">=</span>/home/katsyoshi/.local/lib:-L/home/katsyoshi/.local/lib: <span class="nt">-C</span> link-arg<span class="o">=</span><span class="nt">-lm</span> <span class="nt">-l</span> pthread
    Finished release <span class="o">[</span>optimized] target<span class="o">(</span>s<span class="o">)</span> <span class="k">in </span>0.03s
installing rust_uuid.so to /path/to/rust_uuid/lib/rust_uuid
/usr/bin/install <span class="nt">-c</span> <span class="nt">-m</span> 0755 rust_uuid.so /path/to/rust_uuid/lib/rust_uuid
<span class="nb">cp </span>tmp/x86_64-linux/rust_uuid/3.2.0/rust_uuid.so tmp/x86_64-linux/stage/lib/rust_uuid/rust_uuid.so
<span class="nv">$ </span>bundle <span class="nb">exec </span>ruby <span class="nt">-rrust_uuid</span> <span class="nt">-e</span> <span class="s1">'puts RustUUID.v4'</span>
2eb053de-8ae7-4669-853b-95f06c872300
</code></pre></div></div>

<p>ようやっと通ったああぁあ!!!!</p>

<h2 id="conclusion">conclusion</h2>

<p>実際は11月の末あたりに <strong>head</strong> でコンパイルできないなあと気がついていたのですが、そのうち直るやろと思っててなにもしなかったのです。いざ <strong>Ruby 3.2</strong> がリリースされたときに試して動かなかったのでやっと対応してみました。</p>

<p>ということで正式に <strong>Rust</strong> がサポートされるようになったのでまた YARUKI がでてきますね。</p>

<p>それはそうと今度は、<a href="https://jekyllrb.com"><strong>jekyll</strong></a> が <strong>Ruby 3.2</strong> で動かなくなった。</p>

  </div>

  <h1><a href="/blog/2022/10/15/goodbey-onamae-dot-com/">お名前ドットコムのメールがうざすぎたので DNS を Cloudflare に移行して快適生活</a></h1>
  <p class="author">
    <span class="date">2022-10-15 23:59:50 +0900</span>
  </p>
  <div class="content">
    <p><strong>katsyoshi.org</strong> の登録先を <a href="https://www.onamae.com"><strong>お名前ドットコム</strong></a> にしてたけど、広告のようなメールとか届くし
更新案内と広告の違いがわからない感じのメールが大量にくるのでやめようやめようと思ってたのでいいかげん変えてみた話。</p>

<h2 id="準備">準備</h2>

<p>準備として移行先のレジストラを選定します。
移行先としては普通のレジストラとクラウド業者がやっているレジストラがあると思いますが、今回は以下3つを候補にしました。</p>

<ol>
  <li><a href="https://domains.google/intl/ja_jp/"><strong>Google Domains</strong></a>: <strong>Google</strong> がやっているやつ。メールとか <strong>Google</strong> なんで <em>DNS</em> まで <strong>Google</strong> にするのは心理的抵抗が強い。</li>
  <li><a href="https://aws.amazon.com/jp/route53/"><strong>Route 53</strong></a>: みんなつかってる <strong>AWS</strong> のサービス。仕事で利用しているので、プライベートは別のがいいかな。</li>
  <li><a href="https://www.cloudflare.com/ja-jp/dns/"><strong>Cloudflare の DNS</strong></a>: みんなだいすき低価格 <em>CDN</em> 業者の <a href="https://cloudflare.com"><strong>Cloudflare</strong></a> がやってる <em>DNS</em> サービス。</li>
</ol>

<p><strong>Google</strong> 、 <strong>AWS</strong> は言わずと知れた巨大企業でサービスがなくなるということはないとおもうが、
仕事で利用したり、情報全部預けたりしているところなので選択する理由が個人的には弱い。
個人利用でガンガン変えたり、 <strong>VPC</strong> でネットワーク構築するわけじゃないので <strong>Cloudflare</strong> でいいかなと。</p>

<h3 id="お名前ドットコムでの作業">お名前ドットコムでの作業</h3>

<p>レジストラを移管する前に現在登録してある <a href="https://www.nic.ad.jp/ja/whois/">WHOIS 情報</a> を確認します。
これは移管作業で移管作業用コードが WHOIS 登録者にメールが送られてくるのでどのメールアドレスかの確認です。
ここで<a href="https://www.onamae.com/service/d-regist/option.html">WHOIS 情報公開代行</a> を利用している場合は、
WHOIS を一旦登録時のものに変更します<sup id="fnref:org" role="doc-noteref"><a href="#fn:org" class="footnote" rel="footnote">1</a></sup>。</p>

<h2 id="移管">移管</h2>

<p>移管作業としては新規レジストラで<a href="https://developers.cloudflare.com/registrar/get-started/transfer-domain-to-cloudflare/">移管依頼</a>を参考に移管依頼ページを開きます。
開いたら、旧サービスから移管コードの発行を行ないます<sup id="fnref:onamae" role="doc-noteref"><a href="#fn:onamae" class="footnote" rel="footnote">2</a></sup>。
移管コードを <a href="https://zenn.dev/a24k/articles/20220527-cloudflare-dns"><strong>Cloudflare</strong> 側で入力して</a>しばし待機。</p>

<p>しばらくしたら、レコードが登録されるので完了です。</p>

<h2 id="おわり">おわり</h2>

<p>ということで <em>DNS</em> の登録を <strong>Cloudflare</strong> へ移管しました。
<strong>お名前ドットコム</strong> はあのメールさえなければ続けたのかもしれない。
が更新警告と普通のメールの違いがあまりにもわからないので捨てることにしました。
<strong>Cloudflare</strong> で不満があったらまた変更すると思いますが、快適な生活になりました(たぶん</p>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:org" role="doc-endnote">
      <p>前に移行しようとしたとき、<strong>.org</strong> のドメインは WHOIS 情報書き変えられなくて移行失敗。現在この制限はなくなったので移行。 <a href="#fnref:org" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:onamae" role="doc-endnote">
      <p>こいつが見つけにくく、お名前ドットコムからは見つけられずに<a href="https://www.tsukimi.net/domain_onamae_xdomain.html">移管レポートブログ</a>から発見。 <a href="#fnref:onamae" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <h1><a href="/blog/2022/10/12/ipv6nize-at-home/">Communicate on IPv6 from home</a></h1>
  <p class="author">
    <span class="date">2022-10-12 23:59:50 +0900</span>
  </p>
  <div class="content">
    <p>家のネットワークからインターネットへ出るとき <code class="language-plaintext highlighter-rouge">IPoE</code> を使ってたけど、家庭内 LAN のネットワークは <code class="language-plaintext highlighter-rouge">IPv6</code> を off にしていた。
この LAN 内 <code class="language-plaintext highlighter-rouge">IPv6</code> 化していなかった理由としては、昔 Linux (だけじゃないかも)が <code class="language-plaintext highlighter-rouge">IPv6</code> が利用できる状態だと
先に <code class="language-plaintext highlighter-rouge">IPv6</code> で繋ぎにいこうとして <code class="language-plaintext highlighter-rouge">IPv6</code> で通信できなかったら <code class="language-plaintext highlighter-rouge">IPv4</code> にフォールバックするという挙動で、すごくストレスフルだった。
この挙動の対処として、カーネルレベルで <code class="language-plaintext highlighter-rouge">IPv6</code> を off にしてました。
そうこうしているうちに契約している ISP が <code class="language-plaintext highlighter-rouge">IPv6</code> オプションなしで <code class="language-plaintext highlighter-rouge">IPoE</code> を利用できるようになったので、
とりあえず <code class="language-plaintext highlighter-rouge">IPoE</code> だけを利用できるようにして、家庭内の LAN はそのままという状態にしていました。
いいかげんこの家庭内 LAN のネットワークを <code class="language-plaintext highlighter-rouge">IPv6</code> 化し、インターネットと <code class="language-plaintext highlighter-rouge">IPv6</code> で通信できるようにした顛末をのこす。のこします。</p>

<h2 id="家庭内-lan-環境">家庭内 LAN 環境</h2>

<ul>
  <li>ゲートウェイ: NEC IP38X/1210 (YAMAHA RTX1200)</li>
  <li>PC: 6.0.0-gentoo</li>
</ul>

<p><img src="/images/home2internet.png" alt="" /></p>

<h2 id="ipoe-化と家庭内-lan-の-ipv6-化">IPoE 化と家庭内 LAN の IPv6 化</h2>

<p>設定は <a href="https://network.yamaha.com/setting/router_firewall/flets/flets_other_service/ipv6_ipoe">YAMAHA の設定例集</a>に載ってあるのでそれを参考にします。
<code class="language-plaintext highlighter-rouge">IPoE</code> 化はこの設定例でいけるのですが、どうも設定したときにミスったらしく、 LAN の IP アドレスが <code class="language-plaintext highlighter-rouge">IPv4</code> ではインターネットへ出ることができるが、
<code class="language-plaintext highlighter-rouge">IPv6</code> ではインターネットへ出ることができない状態になってしまいました。</p>

<h3 id="旧設定">旧設定</h3>
<p>どのような設定だったかは以下に</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip route default gateway tunnel 1
ipv6 prefix 1 ra-prefix@lan2::/64
ipv6 lan1 address ra-prefix@lan2::1/64
ipv6 lan1 prefix ra-prefix@lan2::/64
ipv6 lan1 rtadv send 1
ipv6 lan1 dhcp service server
ipv6 lan2 address auto
ipv6 lan2 secure filter in 1010 1011 1012 2000
ipv6 lan2 secure filter out 3000 dynamic 100 101 102 103 104 105 106
ipv6 lan2 dhcp service client ir=on
ngn type lan2 ntt
tunnel select 1
 tunnel encapsulation ipip
 tunnel endpoint address 2404:8e00::feed:100
 tunnel enable 1
ipv6 filter 1010 pass * * icmp6 * *
ipv6 filter 1011 pass * * tcp * ident
ipv6 filter 1012 pass * * udp * 546
ipv6 filter 2000 reject * * * * *
ipv6 filter 3000 pass * * * * *
ipv6 filter dynamic 100 * * ftp
ipv6 filter dynamic 101 * * domain
ipv6 filter dynamic 102 * * www
ipv6 filter dynamic 103 * * smtp
ipv6 filter dynamic 104 * * pop3
ipv6 filter dynamic 105 * * tcp
ipv6 filter dynamic 106 * * udp
</code></pre></div></div>

<p>この設定ではインターネットとは <code class="language-plaintext highlighter-rouge">IPv4</code> でしか通信できていない状態でした。
でこのトラブルシュートとして知人(<a href="https://twitter.com/n_kane">@n_kane</a>, <a href="https://twitter.com/paina">@paina</a>) のちからを借りてどこまで通じてどこから通じないかを確認しました。</p>

<h3 id="troubleshooting">troubleshooting</h3>

<p>とりあえず <code class="language-plaintext highlighter-rouge">ping6</code> 、 <code class="language-plaintext highlighter-rouge">traceroute6</code> で通じていないことを確認します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ping6 -c 3 google.com

PING  google.com(nrt13s55-in-x0e.1e100.net (2404:6800:4004:824::200e)) 56 データ長(byte)

--- google.com ping 統計 ---
送信パケット数 3, 受信パケット数 0, パケット損失 100%, 時間 2067ミリ秒

$ traceroute6 google.com
traceroute to google.com, 30 hops max, 80 byte packets
 1  * * *
 2  * * *
 3  * * *
 4  * * *
 5  * * *
 6  * * *
 7  * * *
 8  * * *
 9  * * *
10  * * *
11  * * *
12  * * *
13  * * *
14  * * *
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  * * *
22  * * *
23  * * *
24  * * *
25  * * *
26  * * *
27  * * *
28  * * *
29  * * *
30  * * *
</code></pre></div></div>

<p>通ってないですね。
先述したように PC は <code class="language-plaintext highlighter-rouge">IPv6</code> を on にしたばかりなのでクライアント側の設定でブロックしていないかを確認します。
まずクライアント側で考えられるのは <code class="language-plaintext highlighter-rouge">iptables</code> でのパケットフィルタリングですね。
ルーターの下にある PC なので、ここでブロックすることは低いのですが、確認します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ip6tables --list
Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination
</code></pre></div></div>

<p>なにもフィルタリングしていないですね。
ということで、クライアント側には問題なさそうですね。
どこまで通じてどこまで通じていないのか別のエンドポイントで確認します。</p>

<p>まず、手元と相手で <code class="language-plaintext highlighter-rouge">tcpdump</code> 利用してパケットが送っているか届いているかを確認します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># tcpdump -nei enp8s0f0 icmp6
dropped privs to pcap
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on enp8s0f0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
22:35:41.158558 00:a0:de:69:40:9d &gt; 33:33:ff:51:5e:63, ethertype IPv6 (0x86dd), length 86: fe80::212:e2ff:fe70:6144 &gt; ff02::1:ff51:5e63: ICMP6, neighbor solicitation, who has 2409:10:a5c0:1f00:d903:ddb5:851:5e63, length 32
22:35:58.765783 ee:60:51:38:43:9c &gt; 33:33:ff:00:00:01, ethertype IPv6 (0x86dd), length 86: 2409:10:a5c0:1f00:5ce3:afcb:9bb2:5c1b &gt; ff02::1:ff00:1: ICMP6, neighbor solicitation, who has 2409:10:a5c0:1f00::1, length 32
22:36:09.249427 ee:60:51:38:43:9c &gt; 33:33:ff:00:00:01, ethertype IPv6 (0x86dd), length 86: 2409:10:a5c0:1f00:5ce3:afcb:9bb2:5c1b &gt; ff02::1:ff00:1: ICMP6, neighbor solicitation, who has 2409:10:a5c0:1f00::1, length 32
</code></pre></div></div>

<p>送れてはいるようで対向側にも届いていたらしく戻りのパケットは送ってたようですが、手元では戻ってくるパケットは見えていないですね。</p>

<p><img src="/images/ping6-failure.png" alt="" /></p>

<p>ということはやはりルーターの設定が悪そうということが推察されますね。
設定のどこが悪いのかあやしいところを見ていきます。</p>

<p>最初に怪しいとおもったのはルーターのフィルターまわりです。一旦、<code class="language-plaintext highlighter-rouge">no ipv6 interface secure filer in</code> で全部無効化しましょう。しかしとくに変りはないです。これはフィルターが原因ではなさそうですね。</p>

<p>次にあやしい点は以下2つの設定</p>

<ol>
  <li><a href="http://www.rtpro.yamaha.co.jp/RT/manual/rt-common/ipv6/ipv6_interface_address.html"><code class="language-plaintext highlighter-rouge">ipv6 interface address</code></a></li>
  <li><a href="http://www.rtpro.yamaha.co.jp/RT/manual/rt-common/ipv6/ipv6_interface_address.html"><code class="language-plaintext highlighter-rouge">ipv6 interface prefix</code></a></li>
</ol>

<p>上のコマンドは ISP から自動で振ってきている IP を割り当てる設定で、下のコマンドは ISP から振ってきた <code class="language-plaintext highlighter-rouge">IPv6</code> のプレフィックスを付けるようにするための設定となります。
どうもこの下のコマンドが邪魔なようです。
<code class="language-plaintext highlighter-rouge">no ipv6 interface prefix</code> で無効化できるので一旦外してみましょう。
すると</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ping6 -c 3 google.com
PING google.com(nrt20s18-in-x0e.1e100.net (2404:6800:4004:81c::200e)) 56 データ長(byte)
64 バイト応答 送信元 nrt20s18-in-x0e.1e100.net (2404:6800:4004:81c::200e): icmp_seq=1 ttl=57 時間=6.53ミリ秒
64 バイト応答 送信元 nrt20s18-in-x0e.1e100.net (2404:6800:4004:81c::200e): icmp_seq=2 ttl=57 時間=2.73ミリ秒
64 バイト応答 送信元 nrt20s18-in-x0e.1e100.net (2404:6800:4004:81c::200e): icmp_seq=3 ttl=57 時間=2.81ミリ秒

--- google.com ping 統計 ---
送信パケット数 3, 受信パケット数 3, パケット損失 0%, 時間 2002ミリ秒
rtt 最小/平均/最大/mdev = 2.731/4.023/6.532/1.773ミリ秒
</code></pre></div></div>

<p>のように通りました!勝ったッ!第三部完!</p>

<h2 id="おわり">おわり</h2>

<p>以前中途半端に設定したおかげで <code class="language-plaintext highlighter-rouge">IPv6</code> 有効化に時間が掛ってしまった顛末をまとめました。
これで家のネットワークから <code class="language-plaintext highlighter-rouge">IPv6</code> で通信できるようになりました。
ありがとうございました!</p>

<p>次回 katsyoshi.org お名前.COM やめるってよ</p>

  </div>

  <h1><a href="/blog/2022/09/11/had-lovely-days-at-rubykaigi-2022/">RubyKaigi 最高！</a></h1>
  <p class="author">
    <span class="date">2022-09-11 23:59:50 +0900</span>
  </p>
  <div class="content">
    <p><a href="https://rubykaigi.org/2022">RubyKaigi 2022</a> に行ってきました! ので感想を</p>

<h2 id="day-0">DAY 0</h2>

<p>今回も <a href="https://yancya.house/">やんちゃハウス</a> に楽をして泊まることにしてたのでなにも気にせず宿へ。
着いて他メンバーが来るまで宿で待機してたが、最寄り駅の周りが思った以上になにもなく、途方に暮れてました。</p>

<h4 id="夕飯">夕飯</h4>

<p>もうひとり宿に着いたので入れ変わりで夕飯へ出かけたが、そもそも最寄り駅前にはなにもないので伊勢駅まで出ることにした。</p>

<p>この判断が間違えてたようで、伊勢駅に出てもとくに変らなかった。しかし幸い伊勢駅前に担々麺屋があったのでそこで食料摂取した。</p>

<h2 id="day-1">DAY 1</h2>

<p>この日の聞いたセトリと感想は以下のとおり</p>

<h4 id="ruby-meets-webassembly-presentation"><a href="https://rubykaigi.org/2022/presentations/kateinoigakukun.html">Ruby meets WebAssembly</a>: <a href="">presentation</a></h4>

<p>この日のキーノートは <a href="https://www.ruby-lang.org/"><code class="language-plaintext highlighter-rouge">Ruby</code></a> の <a href="https://webassembly.org/"><code class="language-plaintext highlighter-rouge">wasm</code></a> 対応の話で <a href="https://wasi.dev/"><code class="language-plaintext highlighter-rouge">wasi</code></a> を通じてブラウザで <code class="language-plaintext highlighter-rouge">Ruby</code> が動かすまでのたのしいことをしゃべってたようです。
おなかいたくてトイレ行ってたら面白いところ聞き逃がしてしまった。</p>

<h4 id="ランチ">ランチ</h4>
<p>適当に幕の内弁当を最初に選択。</p>

<h4 id="making-many-threads-on-ruby-presentation"><a href="https://rubykaigi.org/2022/presentations/ko1.html">Making *MaNy* threads on Ruby</a>: <a href="">presentation</a></h4>

<p>笹田さんの発表で如何に <code class="language-plaintext highlighter-rouge">Ruby</code> で CPU をフルに使えるようにするかの話。 <code class="language-plaintext highlighter-rouge">Ruby</code> での <code class="language-plaintext highlighter-rouge">Thread</code> のはなしから <a href="https://github.com/ruby/ruby/blob/master/doc/ractor.md"><code class="language-plaintext highlighter-rouge">Ractor</code></a> を利用してフルフルに CPU 利用するための書きかたとかの話していました。</p>

<h4 id="building-a-lightweight-ir-and-backend-for-yjit-presentation"><a href="https://rubykaigi.org/2022/presentations/maximecb.html">Building a Lightweight IR and Backend for YJIT</a>: <a href="">presentation</a></h4>

<p><code class="language-plaintext highlighter-rouge">Ruby 3.1</code> で <a href="https://github.com/Shopify/yjit"><code class="language-plaintext highlighter-rouge">YJIT</code></a> が入って <code class="language-plaintext highlighter-rouge">Ruby 3.2</code> でサポートされる CPU アーキテクチャが増えたはなし。RubyVM(？) に <code class="language-plaintext highlighter-rouge">YJIT</code> 用 <code class="language-plaintext highlighter-rouge">Ruby IR</code> を作成して <code class="language-plaintext highlighter-rouge">JIT</code> を実行するという話。
聞いてて疑問になった点としては、 <code class="language-plaintext highlighter-rouge">Ruby IR</code> では直接機械語に翻訳しているようだったが、このバックエンドに <a href="https://llvm.org"><code class="language-plaintext highlighter-rouge">LLVM</code></a> を利用していないのはなんでなんだろう。聞き逃がしているという話はあるので、詳しいひと教えて。</p>

<h4 id="tools-for-providing-rich-user-experience-in-debugger-presentation"><a href="https://rubykaigi.org/2022/presentations/ono-max.html">Tools for Providing rich user experience in debugger</a>: <a href="">presentation</a></h4>

<p><a href="https://github.com/ruby/debug"><code class="language-plaintext highlighter-rouge">debug.gem</code></a> を <a href="https://code.visualstudio.com/"><code class="language-plaintext highlighter-rouge">VS Code</code></a> だけじゃなく、 <a href="https://www.google.com/intl/ja_jp/chrome/"><code class="language-plaintext highlighter-rouge">Chrome</code></a> のリモートデバッグ機能を利用したデバッグの話でした。
この機能自体はすごく便利だと思うのですが、そもそも両方とも宗教上の理由で利用できない体なので聞くだけでした。</p>

<h4 id="trick-2022-returns-repos"><a href="https://rubykaigi.org/2022/presentations/tric.html">TRICK 2022 (Returns)</a>: <a href="">repos</a></h4>

<p>いつも通り <del>変な</del> エキセントリックなプログラムしか出てこなかったし、いつもの面子が賞もらってたのですごいなーという感想。</p>

<h4 id="夕飯-1">夕飯</h4>

<p>この日は津駅があまりなさそうだったので、駅近くで飲むのではなく、宿寄りの場所松坂駅で飲むことにした。
ここで、津の夜情報を聞き込んだり、朝ごはん情報自体を仕入れてました。</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">昨日の夕飯 <a href="https://twitter.com/hashtag/rubykaigi?src=hash&amp;ref_src=twsrc%5Etfw">#rubykaigi</a> <a href="https://t.co/G8lmetYX9J">pic.twitter.com/G8lmetYX9J</a></p>&mdash; katsyoshi (@katsyoshi) <a href="https://twitter.com/katsyoshi/status/1568012256566480896?ref_src=twsrc%5Etfw">September 8, 2022</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<h2 id="day-2">DAY 2</h2>
<p>2日目は、ネットワークが不安定になったりしてこちらの集中力が切れたりしたのであまり覚えていない。</p>

<h4 id="朝ごはん">朝ごはん</h4>

<p>前日の夕飯に教えてもらった市場の人向け食堂が松坂駅前にあり、その食堂で食事をした。</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">朝メッシ <a href="https://twitter.com/hashtag/rubykaigi?src=hash&amp;ref_src=twsrc%5Etfw">#rubykaigi</a> <a href="https://t.co/PvbaUrRUIf">pic.twitter.com/PvbaUrRUIf</a></p>&mdash; katsyoshi (@katsyoshi) <a href="https://twitter.com/katsyoshi/status/1568019085430259712?ref_src=twsrc%5Etfw">September 8, 2022</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<h4 id="matz-keynote-presentation"><a href="https://rubykaigi.org/2022/presentations/yukihiro_matz.html">Matz Keynote</a>: <a href="">presentation</a></h4>

<h4 id="do-pure-ruby-dream-of-encrypted-binary-protocol-presentation"><a href="https://rubykaigi.org/2022/presentations/yu_suke1994.html">Do Pure Ruby Dream of Encrypted Binary Protocol?</a>: <a href="">presentation</a></h4>

<p>ノーコメント。</p>

<h4 id="ランチ-1">ランチ</h4>

<p>この日も一番に弁当を取得。弁当はみんな大好き松坂牛ローストビーフ丼にした。感想としては、もう肉はいいかな。</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">昼飯　<a href="https://twitter.com/hashtag/rubykaigi?src=hash&amp;ref_src=twsrc%5Etfw">#rubykaigi</a> <a href="https://t.co/vpOf6Uwf0K">pic.twitter.com/vpOf6Uwf0K</a></p>&mdash; katsyoshi (@katsyoshi) <a href="https://twitter.com/katsyoshi/status/1568070622210826240?ref_src=twsrc%5Etfw">September 9, 2022</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<h4 id="自キkaigi">自キKaigi</h4>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">きょうも <a href="https://twitter.com/hashtag/%E8%87%AA%E3%82%ADKaigi?src=hash&amp;ref_src=twsrc%5Etfw">#自キKaigi</a> やります。ランチ食べたらスポンサーエリアの手前あたりにお集まりください <a href="https://twitter.com/hashtag/rubykaigi?src=hash&amp;ref_src=twsrc%5Etfw">#rubykaigi</a></p>&mdash; 🇺🇦hasumikin🇺🇦 (@hasumikin) <a href="https://twitter.com/hasumikin/status/1568023525407211521?ref_src=twsrc%5Etfw">September 8, 2022</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>誘われたので参加しました。iPad で活動しようと思い <a href="https://github.com/foostan/crkbd">corne</a> 持っていってたので参加してた。</p>

<h4 id="ruby-x-bpf-in-action-how-important-observability-is-presentation"><a href="https://rubykaigi.org/2022/presentations/udzura.html">Ruby x BPF in Action: How important observability is</a>: <a href="">presentation</a></h4>
<h4 id="hunting-production-memory-leaks-with-heap-sampling-presentation"><a href="https://rubykaigi.org/2022/presentations/KnuX.html">Hunting Production Memory Leaks with Heap Sampling</a>: <a href="">presentation</a></h4>
<p>このあたりネットワークが不安定になり、セッションが中断されたりしたためあまり覚えていない。</p>

<h4 id="立ち話">立ち話</h4>

<p>久し振りの対面での参加だったのでセッションあまり聞かずに受け付け前で立ち話している人たちがいたので、その立ち話に参加した。
たまたま、最近読んでる本の翻訳者がいたのでこれからの話などを聞いたりしていた。</p>

<h4 id="caching-with-messagepack-presentation"><a href="https://rubykaigi.org/2022/presentations/shioyama.html">Caching With MessagePack</a>: <a href="">presentation</a></h4>
<h4 id="ruby-committers-vs-the-world"><a href="https://rubykaigi.org/2022/presentations/rubylangorg.html">Ruby Committers vs The World</a></h4>

<h4 id="夕飯-2">夕飯</h4>

<p>夕飯は、駅近くのお店でかるく3人で。</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">いまどこ</p>&mdash; tagomoris (@tagomoris) <a href="https://twitter.com/tagomoris/status/1568221035702685696?ref_src=twsrc%5Etfw">September 9, 2022</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>こんなリプライがきてたようなので一緒にいたひとにまかせた。ギリギリまで粘ってたので帰宿後すぐ就寝。</p>

<h2 id="day-3">DAY 3</h2>

<p>3日目はそもそも前2日の疲れが出たりしたのかほとんど覚えていない。あと <a href="https://ruby-puzzles-2022.cookpad.tech/">ruby puzzle</a> をやっていてセッションをあまり聞けていない。</p>

<h4 id="朝ごはん-1">朝ごはん</h4>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">今日も一日 <a href="https://twitter.com/hashtag/rubykaigi?src=hash&amp;ref_src=twsrc%5Etfw">#rubykaigi</a> <a href="https://t.co/PKnj8sHxwE">pic.twitter.com/PKnj8sHxwE</a></p>&mdash; katsyoshi (@katsyoshi) <a href="https://twitter.com/katsyoshi/status/1568387387088322560?ref_src=twsrc%5Etfw">September 9, 2022</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<h4 id="megaruby---running-mrubyc-programs-on-sega-mega-drive-presentation"><a href="https://rubykaigi.org/2022/presentations/yujiyokoo.html">Megaruby - Running mruby/c programs on Sega Mega Drive</a>: <a href="">presentation</a></h4>

<p>これに間に合うように出たはずだったが、間に合わず聞いていた。メガドライブすげえ。</p>

<h4 id="automatically-find-memory-leaks-in-native-gems-presentation"><a href="https://rubykaigi.org/2022/presentations/peterzhu2118.html">Automatically Find Memory Leaks in Native Gems</a>: <a href="">presentation</a></h4>
<h4 id="fast-data-processing-with-ruby-and-apache-arrow-presentation"><a href="https://rubykaigi.org/2022/presentations/ktou.html">Fast data processing with Ruby and Apache Arrow</a>: <a href="">presentation</a></h4>
<h4 id="fixing-assignment-evaluation-order-presentation"><a href="https://rubykaigi.org/2022/presentations/jeremyevans0.html">Fixing Assignment Evaluation Order</a>: <a href="">presentation</a></h4>
<h4 id="stories-from-developing-yjit-presentation"><a href="https://rubykaigi.org/2022/presentations/alanwusx.html">Stories from developing YJIT</a>: <a href="">presentation</a></h4>

<h2 id="まとめ">まとめ</h2>

<p>3年ぶりの現地開催だったので参加してきました。対面での参加はやはりよいもので新しい出会いや、疑問を本人、解っている人に直接聞くことができてすばらしい体験でした。</p>

<h3 id="三重について">三重について</h3>
<p>三重県の酒のイメージは、行く前は「作」「 而今」「伊勢角谷屋麦酒」というイメージでした。
とくに日本酒は美味しいイメージがあり、知らない日本酒もあったりするんだろうなあと思っていました。
行ってみると日本酒はイメージと変わらないのですが、だいたい似た味の傾向で飽きるというかなんというか
美味しいんだけど、好きじゃないという感想になってしまった。
ビールについては瓶ビールしか飲まなかったので感想はなしで。</p>

<p>三重は大きな街が比較的分散しているようで、津も松坂も伊勢も鳥羽も駅前が小さく感じました。
とくに0日目の食事が大変で、調達が難しかった。</p>

  </div>

  <h1><a href="/blog/2022/08/12/how-to-use-rust-in-ruby-gems/">Ruby gem で Rust をつかって爆速にしたい!!!!!!11</a></h1>
  <p class="author">
    <span class="date">2022-08-12 13:59:59 +0900</span>
  </p>
  <div class="content">
    <p><a href="https://rubygems.org">Ruby Gems</a> で <a href="https://www.rust-lang.org">Rust</a> が <a href="https://github.com/rubygems/rubygems/pull/5175">Native として利用可能になった</a> のでとりあえず <a href="https://www.rfc-editor.org/rfc/rfc4122.html"><code class="language-plaintext highlighter-rouge">UUIDv4</code></a> を生成してみた。</p>

<h3 id="リポジトリ">リポジトリ</h3>
<p><a href="https://github.com/katsyoshi/rust_uuid"><img src="https://gh-card.dev/repos/katsyoshi/rust_uuid.svg" alt="katsyoshi/rust_uuid - GitHub" /></a></p>

<h2 id="準備">準備</h2>

<p>Ruby 側の <code class="language-plaintext highlighter-rouge">gem</code> に Rust を利用する準備として <a href="https://github.com/oxidize-rb/rb-sys"><code class="language-plaintext highlighter-rouge">rb_sys</code></a> と <a href="https://github.com/rake-compiler/rake-compiler"><code class="language-plaintext highlighter-rouge">rake-compiler</code></a> を利用します。この二つの <code class="language-plaintext highlighter-rouge">gem</code> は native compile するためにインストールしておきます。
Rust 側から Ruby へ関数を公開するために <a href="https://github.com/oxidize-rb/rb-sys"><code class="language-plaintext highlighter-rouge">rb-sys</code></a> と <a href="https://github.com/matsadler/magnus"><code class="language-plaintext highlighter-rouge">magnus</code></a> を利用します。</p>

<h2 id="gem-install">gem install</h2>

<p>とりあえず <code class="language-plaintext highlighter-rouge">cargo</code> で Rust のパッケージを作って Rust を書いてみます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> bundle gem rust_uuid <span class="nt">--mit</span> <span class="nt">--ext</span> rust_uuid <span class="c"># --ext を指定してnative build する gem を作成</span>
<span class="o">&gt;</span> <span class="nb">cd </span>rust_uuid <span class="c"># 作成した gem のディレクトリへ移動</span>
<span class="o">&gt;</span> <span class="nb">cd </span>ext/rust_uuid <span class="c"># ビルドするディレクトリへ移動</span>
<span class="o">&gt;</span> cargo init <span class="nb">.</span> <span class="nt">--lib</span> <span class="c"># cargo を初期化</span>
<span class="o">&gt;</span> <span class="nb">rm</span> <span class="nt">-f</span> <span class="k">*</span>.c <span class="k">*</span>.h <span class="c"># C のファイルが生成されるので削除</span>
<span class="o">&gt;</span> cargo add rb-sys rb-allocator
<span class="o">&gt;</span> cargo add magnus <span class="nt">--features</span> rb-sys-interop
<span class="o">&gt;</span> cargo add uuid <span class="nt">--features</span> v4 <span class="c"># uuid v4 を指定</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ext/rust_uuid/extconf.rb</code> を以下のように編集します。</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@@ -1,5 +1,6 @@</span>
 # frozen_string_literal: true
 
 require "mkmf"
<span class="gi">+require "rb_sys/mkmf"
</span> 
<span class="gd">-create_makefile("rust_uuid/rust_uuid")
</span><span class="gi">+create_rust_makefile("rust_uuid/rust_uuid")
</span></code></pre></div></div>

<p>次に <code class="language-plaintext highlighter-rouge">ext/rust_uuid/src/lib.rs</code> を以下の様に変更します。</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">magnus</span><span class="p">::{</span><span class="n">define_module</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="nn">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">,</span> <span class="n">Error</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">rb_allocator</span><span class="p">::</span><span class="n">ruby_global_allocator</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">uuid</span><span class="p">::</span><span class="n">Uuid</span><span class="p">;</span>

<span class="nd">ruby_global_allocator!</span><span class="p">();</span>

<span class="c1">// UUIDv4 を文字列として公開</span>
<span class="k">fn</span> <span class="nf">v4</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
    <span class="nn">Uuid</span><span class="p">::</span><span class="nf">new_v4</span><span class="p">()</span><span class="nf">.to_string</span><span class="p">()</span>
<span class="p">}</span>

<span class="nd">#[magnus::init]</span>
<span class="k">fn</span> <span class="nf">init</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">module</span> <span class="o">=</span> <span class="nf">define_module</span><span class="p">(</span><span class="s">"RustUUID"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="c1">// RustUUID.v4 と利用するようにシングルトンメソッドを定義</span>
    <span class="n">module</span><span class="nf">.define_singleton_method</span><span class="p">(</span><span class="s">"v4"</span><span class="p">,</span> <span class="nd">function!</span><span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div></div>

<p>これまでできたら一旦 Rust をコンパイルしましょう。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">cd </span>ext/rust_uuid
<span class="o">&gt;</span> cargo build
<span class="o">&gt;</span> git add <span class="nb">.</span>
<span class="o">&gt;</span> rake build
.... <span class="c"># install cargo dependencies and packages</span>
<span class="nb">cp</span>: <span class="s1">'/home/katsyoshi/Program/Ruby/rust_uuid/tmp/x86_64-linux/rust_uuid/3.1.2/target/release/librust_uuid.so'</span> を <span class="nb">stat </span>できません: そのようなファイルやディレクトリはありません
gmake: <span class="k">***</span> <span class="o">[</span>Makefile:551: foo_bar.so] エラー 1
rake aborted!
Command failed with status <span class="o">(</span>2<span class="o">)</span>: <span class="o">[</span>/usr/bin/gmake...]

Tasks: TOP <span class="o">=&gt;</span> build <span class="o">=&gt;</span> compile <span class="o">=&gt;</span> compile:x86_64-linux <span class="o">=&gt;</span> compile:foo_bar:x86_64-linux <span class="o">=&gt;</span> copy:rust_uuid:x86_64-linux:3.1.2 <span class="o">=&gt;</span> tmp/x86_64-linux/rust_uuid/3.1.2/rust_uuid.so
</code></pre></div></div>

<p>とエラーになります。
これは <code class="language-plaintext highlighter-rouge">ext/rust_uuid/Cargo.toml</code> の設定が足りていません。そこで以下を追加してみてください。</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[lib]</span>
<span class="py">crate-type</span> <span class="p">=</span> <span class="p">[</span><span class="s">"cdylib"</span><span class="p">]</span>
</code></pre></div></div>

<p>追加したら <code class="language-plaintext highlighter-rouge">gem</code> をビルド&amp;&amp;インストール&amp;&amp;試してみましょう!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> rake <span class="nb">install</span>
....
<span class="o">&gt;</span> ruby <span class="nt">-rrust_uuid</span> <span class="nt">-e</span> <span class="s1">'puts RustUUID.v4'</span>
2be6f4d2-200b-4d08-9a1a-11fa523b316b
</code></pre></div></div>

<h2 id="べんちまーく">べんちまーく</h2>

<p>以下、 <code class="language-plaintext highlighter-rouge">SecureRandom.uuid</code> との比較用のベンチマークコードを示します。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"benchmark/ips"</span>
<span class="nb">require</span> <span class="s2">"securerandom"</span>
<span class="nb">require</span> <span class="s2">"rust_uuid"</span>

<span class="no">Benchmark</span><span class="p">.</span><span class="nf">ips</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"standard"</span><span class="p">)</span> <span class="p">{</span> <span class="no">SecureRandom</span><span class="p">.</span><span class="nf">uuid</span> <span class="p">}</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"rust lib"</span><span class="p">)</span> <span class="p">{</span> <span class="no">RustUUID</span><span class="p">.</span><span class="nf">v4</span> <span class="p">}</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">compare!</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="結果発表">結果発表〜</h3>

<p>Rust を利用することでだいたい 5 倍ほど速くなっています。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>ruby bentimark.rb
<span class="go">Warming up --------------------------------------
            standard    36.437k i/100ms
            rust lib   177.585k i/100ms
Calculating -------------------------------------
            standard    365.407k (± 1.4%) i/s -      1.858M in   5.086491s
            rust lib      1.793M (± 1.8%) i/s -      9.057M in   5.053179s

Comparison:
            rust lib:  1792925.9 i/s
            standard:   365407.3 i/s - 4.91x  (± 0.00) slower

ruby bentimark.rb  9.88s user 4.30s system 99% cpu 14.175 total
</span></code></pre></div></div>

<p>TOO HAYAI</p>

<h2 id="まとめ">まとめ</h2>
<p>簡単に Rust を利用して速くしてみました。
思った以上に速くなっていたので重い処理をする場合に <code class="language-plaintext highlighter-rouge">C</code> や <code class="language-plaintext highlighter-rouge">C++</code> 以外でも簡単に利用できるようになって
選択肢が増えたのはよいことでした。</p>

<p>実はこの <code class="language-plaintext highlighter-rouge">uuid</code> crate の features に <code class="language-plaintext highlighter-rouge">fast-rng</code> を追加すると 10 倍速くなるんですが、 ruby 側の終了時に <code class="language-plaintext highlighter-rouge">SEGV</code> してしまうので載せていないです。 <code class="language-plaintext highlighter-rouge">SEGV</code> しないように原因を調査などはまた今度。</p>

  </div>

  <h1><a href="/blog/2022/03/19/hello-wezterm/">Hello, Wezterm</a></h1>
  <p class="author">
    <span class="date">2022-03-19 18:00:00 +0900</span>
  </p>
  <div class="content">
    <p><a href="https://github.com/tmux/tmux"><code class="language-plaintext highlighter-rouge">tmux</code></a> + <a href="https://github.com/tmux/tmux"><code class="language-plaintext highlighter-rouge">Allacritty</code></a> が疲れてきたので<a href="https://zenn.dev/yutakatay/articles/wezterm-intro">はてぶで流れてきた</a> <a href="https://github.com/wez/wezterm"><code class="language-plaintext highlighter-rouge">wezterm</code></a> が <a href="https://github.com/saitoha/libsixel"><code class="language-plaintext highlighter-rouge">sixel</code></a> を利用できてよさそうだったので試してみることにした。</p>

<h2 id="設定">設定</h2>

<p>設定ファイルが <a href="https://www.lua.org/">lua</a> でカスタマイズがいろいろとできるのでまずは色を代えてみます。</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">wezterm</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">'wezterm'</span>
<span class="k">return</span> <span class="p">{</span>
  <span class="n">color_scheme</span> <span class="o">=</span> <span class="s2">"Dracula"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>プログラミング言語でカスタマイズができるので以下のようにアクティブなタブへの移動のキーバインドのカスタマイズができます。</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">wezterm</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">'wezterm'</span>
<span class="kd">local</span> <span class="n">move_keys</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">9</span> <span class="k">do</span>
   <span class="nb">table.insert</span><span class="p">(</span><span class="n">move_keys</span><span class="p">,</span> <span class="p">{</span>
      <span class="n">key</span> <span class="o">=</span> <span class="nb">tostring</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
      <span class="n">mods</span> <span class="o">=</span> <span class="s2">"CTRL"</span><span class="p">,</span>
      <span class="n">action</span> <span class="o">=</span> <span class="n">wezterm</span><span class="p">.</span><span class="n">action</span><span class="p">{</span> <span class="n">ActivateTab</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
   <span class="p">})</span>
<span class="k">end</span>

<span class="k">return</span> <span class="p">{</span>
   <span class="n">color_scheme</span> <span class="o">=</span> <span class="s2">"Dracula"</span><span class="p">,</span>
   <span class="n">disable_default_key_bindings</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">-- 初期のキーバインドは利用しない場合</span>
   <span class="n">keys</span> <span class="o">=</span> <span class="n">move_keys</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>こんな感じで設定できるので便利です。</p>

<p>このキーバインドは任意のイベントも設定でき、任意のイベントを利用してアクションを定義できます。以下の例では、Paneを開い監視用のプログラムを開きます。</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">wezterm</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">'wezterm'</span>
<span class="n">wezterm</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s2">"open-nvtop-and-ytop"</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">pane</span><span class="p">)</span>
   <span class="n">win</span><span class="p">:</span><span class="n">perform_action</span><span class="p">(</span><span class="n">wezterm</span><span class="p">.</span><span class="n">action</span><span class="p">{</span> <span class="n">SplitHorizontal</span> <span class="o">=</span> <span class="p">{</span> <span class="n">domain</span> <span class="o">=</span> <span class="s2">"CurrentPaneDomain"</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"nvtop"</span><span class="p">,</span> <span class="p">},</span> <span class="p">},</span> <span class="p">},</span> <span class="n">pane</span><span class="p">)</span>
   <span class="n">win</span><span class="p">:</span><span class="n">perform_action</span><span class="p">(</span><span class="n">wezterm</span><span class="p">.</span><span class="n">action</span><span class="p">{</span> <span class="n">SplitVertical</span> <span class="o">=</span> <span class="p">{</span> <span class="n">domain</span> <span class="o">=</span> <span class="s2">"CurrentPaneDomain"</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"ytop"</span><span class="p">,</span> <span class="s2">"-ps"</span><span class="p">,</span> <span class="p">},</span> <span class="p">},</span> <span class="p">},</span> <span class="n">pane</span><span class="p">)</span>
<span class="k">end</span><span class="p">)</span>

<span class="k">return</span> <span class="p">{</span>
   <span class="n">keys</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="n">key</span> <span class="o">=</span> <span class="s2">"r"</span><span class="p">,</span> <span class="n">mods</span> <span class="o">=</span> <span class="s2">"CTRL"</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">wezterm</span><span class="p">.</span><span class="n">action</span><span class="p">{</span> <span class="n">EmitEvent</span> <span class="o">=</span> <span class="s2">"open-nvtop-and-ytop"</span><span class="p">,</span> <span class="p">},</span> <span class="p">},</span> <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div>

<p>とすると以下のようになります。
<img src="/images/screenshot/open-nvtop-and-ytop-in-wezterm.png" width="100%" />
便利!</p>

<p>こんな便利なものということで <code class="language-plaintext highlighter-rouge">systemd</code> でデーモン化しています。</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[Unit]</span>
<span class="py">Description</span><span class="p">=</span><span class="err">GUI</span> <span class="err">Accellarated</span> <span class="err">terminal</span>
<span class="py">Documentation</span><span class="p">=</span>

<span class="nn">[Service]</span>
<span class="py">Type</span><span class="p">=</span><span class="err">forking</span>
<span class="py">ExecStart</span><span class="p">=</span><span class="err">/usr/local/bin/wezterm-mux-server</span> <span class="err">--daemonize</span>
<span class="py">Restart</span><span class="p">=</span><span class="err">on-failure</span>

<span class="nn">[Install]</span>
<span class="py">WantedBy</span><span class="p">=</span><span class="err">default.target</span>
</code></pre></div></div>

<p>で起動しておいています</p>

<h3 id="問題点">問題点</h3>

<p>と設定ファイルの例書いてみたのですが、とても大きな問題点にブチあたったので書いておきます。</p>

<p><code class="language-plaintext highlighter-rouge">wezterm</code> には <code class="language-plaintext highlighter-rouge">wezterm-mux-server</code> というマルチプレクサ(tmuxのように扱うため)のサーバーモードプログラムがあるのですが、こいつがどうも <code class="language-plaintext highlighter-rouge">wezterm</code> とは挙動が異なり、前述した監視用のキーバインドが微妙に異なった挙動となってしまっています。サーバーモードに接続した場合の挙動は以下のようになります。</p>

<p><img src="/images/screenshot/failed-nvtop-ytop.png" width="100%" /></p>

<p>1つ目はpaneの位置が期待したとおりになっていない。2つ目は <code class="language-plaintext highlighter-rouge">ytop</code> が起動していないというので2つ目の方は気にしなければいいのでまあいいかと思っている。1つ目の問題は許容できていないので一旦はこのキーバインドは封印となっています。</p>

<h1 id="おわり">おわり</h1>

<p>長年利用してた <code class="language-plaintext highlighter-rouge">tmux</code> を捨てて <code class="language-plaintext highlighter-rouge">wezterm</code> を利用しはじめた。
設定が <code class="language-plaintext highlighter-rouge">lua</code> で書けるのが体験的にとても良いのでこれからも利用するかなと。
<code class="language-plaintext highlighter-rouge">wezterm</code> で <code class="language-plaintext highlighter-rouge">sixel</code> 利用した画像表示ができるようになったのが便利なので「よしっ！」</p>


  </div>

  <h1><a href="/blog/2022/01/03/hello-2022/">冬やすみ</a></h1>
  <p class="author">
    <span class="date">2022-01-03 23:59:59 +0900</span>
  </p>
  <div class="content">
    <p>冬やすみの間、やりたいこと、やっといたほうがいいやつをやってました。
ひとつは <a href="/blog/2021/12/26/xremap/">xremap</a> の設定ともうひとつは <a href="/blog/2021/12/30/custom-co2mini-co2-sensor/">CO2-mini から CO<sub>2</sub> を見える</a> ようにした。</p>

<p>今回は、 <a href="https://mackerel.io"><strong>mackerel</strong></a> で見えるようになった <strong>CO<sub>2</sub></strong> の値を <strong>Slack</strong> へ定期的に投げるようにします。今回も <a href="https://www.rust-lang.org"><strong>Rust</strong></a> を利用しています。</p>

<h2 id="準備">準備</h2>

<p>準備として、 <strong>mackerel</strong> <sup id="fnref:mackerel-token" role="doc-noteref"><a href="#fn:mackerel-token" class="footnote" rel="footnote">1</a></sup> と <strong>Slack</strong> <sup id="fnref:slack-token" role="doc-noteref"><a href="#fn:slack-token" class="footnote" rel="footnote">2</a></sup>
両アプリケーションの投稿 API 用 Token をそれぞれ用意します。
各公式ページにあるように生成、取得するだけでよいです。</p>

<p><strong>mackerel</strong> 側は <a href="https://mackerel.io/ja/api-docs/entry/host-metrics#get">ホストメトリック API</a> を利用します。
<strong>Slack</strong> 側は <a href="https://api.slack.com/methods/chat.postMessage">chat.postMessage API</a> を利用します。
各 API に対して取得した API Token を用いて <code class="language-plaintext highlighter-rouge">curl</code> で確認しておきます。</p>

<h2 id="実装">実装</h2>

<p>今回は対話式の <strong>bot</strong> ではないので、 <a href="https://api.slack.com/rtm"><strong>RTM</strong></a> を利用せずに、<strong>HTTP</strong> クライアントだけで構成しています<sup id="fnref:slack-rs" role="doc-noteref"><a href="#fn:slack-rs" class="footnote" rel="footnote">3</a></sup>。
<strong>Rust</strong> の <strong>HTTP</strong> クライアントとして <a href="https://github.com/hyperium/hyper"><strong>hyper</strong></a><sup id="fnref:hyper-warning" role="doc-noteref"><a href="#fn:hyper-warning" class="footnote" rel="footnote">4</a></sup> を利用します。
<strong>TLS</strong> は <a href="https://github.com/hyperium/hyper-tls"><strong>hyper_tls</strong></a> を利用しています。</p>

<p>実装とは言っても対象の <strong>mackerel</strong> の APIを叩き値を取得して、
その値を元に <strong>Slack</strong> へポストするだけです。</p>

<p><strong>mackerel</strong> での値取得時に気をつける点としては、<strong>ホストメトリック API</strong> では <code class="language-plaintext highlighter-rouge">host名</code> ではなく、
<code class="language-plaintext highlighter-rouge">host id</code> がパラメーターとなっていますので注意が必要です。
まずレスポンスを入れる構造体を定義します。</p>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[derive(Deserialize)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">Metric</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">time</span><span class="p">:</span> <span class="nb">i64</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">value</span><span class="p">:</span> <span class="nb">i16</span><span class="p">,</span> <span class="c1">// 今回は co2 の値なので i16 としている</span>
<span class="p">}</span>

<span class="nd">#[derive(Deserialize)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">ResponseMetrics</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">metrics</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Metric</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>つぎに以下のようにしてリクエストを組みたてて、値を取得しています。</p>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">https</span> <span class="o">=</span> <span class="nn">HttpsConnector</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
<span class="k">let</span> <span class="n">req</span> <span class="o">=</span> <span class="nn">hyper</span><span class="p">::</span><span class="nn">Request</span><span class="p">::</span><span class="nf">builder</span><span class="p">()</span>
    <span class="nf">.method</span><span class="p">(</span><span class="nn">hyper</span><span class="p">::</span><span class="nn">Method</span><span class="p">::</span><span class="n">GET</span><span class="p">)</span>
    <span class="nf">.uri</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="nf">.header</span><span class="p">(</span><span class="s">"X-Api-Key"</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
    <span class="nf">.body</span><span class="p">(</span><span class="nn">hyper</span><span class="p">::</span><span class="nn">Body</span><span class="p">::</span><span class="nf">empty</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
<span class="c1">// https として request する</span>
<span class="k">let</span> <span class="n">client</span> <span class="o">=</span> <span class="nn">hyper</span><span class="p">::</span><span class="nn">Client</span><span class="p">::</span><span class="nf">builder</span><span class="p">()</span><span class="py">.build</span><span class="p">::</span><span class="o">&lt;</span><span class="n">_</span><span class="p">,</span> <span class="nn">hyper</span><span class="p">::</span><span class="n">Body</span><span class="o">&gt;</span><span class="p">(</span><span class="n">https</span><span class="p">);</span>
<span class="k">let</span> <span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="nf">.request</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>
<span class="k">let</span> <span class="n">body</span> <span class="o">=</span> <span class="nn">hyper</span><span class="p">::</span><span class="nn">body</span><span class="p">::</span><span class="nf">aggregate</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>
<span class="k">let</span> <span class="n">json</span><span class="p">:</span> <span class="n">ResponseMetrics</span> <span class="o">=</span> <span class="nn">serde_json</span><span class="p">::</span><span class="nf">from_reader</span><span class="p">(</span><span class="n">body</span><span class="nf">.reader</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
<span class="k">let</span> <span class="n">metrics</span> <span class="o">=</span> <span class="n">json</span><span class="py">.metrics</span><span class="p">;</span>
</code></pre></div></div>

<p>値を取得したら、今度は同じように <strong>Slack</strong> の方も構造体を定義します。</p>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// リクエスト用構造体</span>
<span class="nd">#[derive(Serialize)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">SlackMessage</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">channel</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">sub_type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">text</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">username</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">as_user</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">}</span>
<span class="c1">// レスポンス用構造体</span>
<span class="nd">#[derive(Deserialize)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">PostMessage</span> <span class="p">{</span>
    <span class="nd">#[allow(unused)]</span>
    <span class="n">channel</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>
<p>リクエストを組みたてて、POSTします。
見てわかると思いますが、ほとんど <strong>mackerel</strong> と変わらないです。</p>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// リクエスト body を json に変換</span>
<span class="k">let</span> <span class="n">json</span> <span class="o">=</span> <span class="nn">serde_json</span><span class="p">::</span><span class="nf">to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SlackMessage</span> <span class="p">{</span>
    <span class="n">channel</span><span class="p">:</span> <span class="s">"channel"</span><span class="nf">.to_string</span><span class="p">(),</span>
    <span class="n">sub_type</span><span class="p">:</span> <span class="s">"bot_message"</span><span class="nf">.to_string</span><span class="p">(),</span>
    <span class="n">text</span><span class="p">:</span> <span class="s">"message"</span><span class="nf">.to_string</span><span class="p">(),</span>
    <span class="n">username</span><span class="p">:</span> <span class="s">"botname"</span><span class="nf">.to_string</span><span class="p">(),</span>
    <span class="n">as_user</span><span class="p">:</span> <span class="k">true</span><span class="p">,</span>
<span class="p">})</span><span class="o">?</span><span class="p">;</span>

<span class="k">let</span> <span class="n">https</span> <span class="o">=</span> <span class="nn">hyper_tls</span><span class="p">::</span><span class="nn">HttpsConnector</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
<span class="k">let</span> <span class="n">req</span> <span class="o">=</span> <span class="nn">hyper</span><span class="p">::</span><span class="nn">Request</span><span class="p">::</span><span class="nf">builder</span><span class="p">()</span>
    <span class="nf">.method</span><span class="p">(</span><span class="nn">hyper</span><span class="p">::</span><span class="nn">Method</span><span class="p">::</span><span class="n">POST</span><span class="p">)</span>
    <span class="nf">.uri</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="nf">.header</span><span class="p">(</span><span class="s">"Content-Type"</span><span class="p">,</span> <span class="s">"application/json"</span><span class="p">)</span>
    <span class="nf">.header</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">,</span> <span class="nd">format!</span><span class="p">(</span><span class="s">"Bearer {}"</span><span class="p">,</span> <span class="nf">get_env</span><span class="p">(</span><span class="s">"SLACK_API_KEY"</span><span class="p">)))</span>
    <span class="nf">.body</span><span class="p">(</span><span class="nn">hyper</span><span class="p">::</span><span class="nn">Body</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="n">json</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>

<span class="k">let</span> <span class="n">client</span> <span class="o">=</span> <span class="nn">hyper</span><span class="p">::</span><span class="nn">Client</span><span class="p">::</span><span class="nf">builder</span><span class="p">()</span><span class="py">.build</span><span class="p">::</span><span class="o">&lt;</span><span class="n">_</span><span class="p">,</span> <span class="nn">hyper</span><span class="p">::</span><span class="n">Body</span><span class="o">&gt;</span><span class="p">(</span><span class="n">https</span><span class="p">);</span>
<span class="k">let</span> <span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="nf">.request</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>
<span class="k">let</span> <span class="n">body</span> <span class="o">=</span> <span class="nn">hyper</span><span class="p">::</span><span class="nn">body</span><span class="p">::</span><span class="nf">aggregate</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>
<span class="k">let</span> <span class="n">_json</span><span class="p">:</span> <span class="n">PostMessage</span> <span class="o">=</span> <span class="nn">serde_json</span><span class="p">::</span><span class="nf">from_reader</span><span class="p">(</span><span class="n">body</span><span class="nf">.reader</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
</code></pre></div></div>

<p>ポストするメッセージを作る際に2つのことをしています。
まずは <code class="language-plaintext highlighter-rouge">time</code> の <strong>UNIX EPOCH TIME</strong> からローカルの時間を表示するようにしています。
それと <strong>CO<sub>2</sub></strong> の値に依って絵文字を追加するかどうかを入れています。 <code class="language-plaintext highlighter-rouge">-1</code> とか予定していない値が入ってきた場合は <code class="language-plaintext highlighter-rouge">panic!</code> するようにしています。</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// chrono を利用して unix time からローカルの文字列へ変換</span>
<span class="k">let</span> <span class="n">t</span> <span class="o">=</span> <span class="nn">chrono</span><span class="p">::</span><span class="n">Local</span><span class="nf">.timestamp</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
<span class="k">let</span> <span class="n">v</span> <span class="o">=</span> <span class="k">match</span> <span class="n">value</span> <span class="p">{</span>
    <span class="mi">0</span><span class="o">..=</span><span class="mi">700</span> <span class="k">=&gt;</span> <span class="s">":large_green_circle:"</span><span class="p">,</span>
    <span class="mi">701</span><span class="o">..=</span><span class="mi">1000</span> <span class="k">=&gt;</span> <span class="s">":large_yellow_circle:"</span><span class="p">,</span>
    <span class="mi">1001</span><span class="o">..</span> <span class="k">=&gt;</span> <span class="s">":red_circle:"</span><span class="p">,</span> <span class="c1">// なんで slack は :large_red_circle: を用意していないんだろうか</span>
    <span class="n">_</span> <span class="k">=&gt;</span> <span class="nd">panic!</span><span class="p">(</span><span class="s">"unexpected number!!"</span><span class="p">),</span>
<span class="p">};</span>
</code></pre></div></div>

<p>こうやってポストされたメッセージは以下のようになります。</p>

<p><img src="/images/screenshot/posted-slack-message.png" alt="" /></p>

<p>絵文字つきでポストされましたね。</p>

<h2 id="まとめ">まとめ</h2>

<p><strong>Rust</strong> で <strong>bot</strong> を作ってみました。
と言ってもただの <strong>HTTP クライアント</strong> な <strong>bot</strong> なだけですけど。
一旦 <strong>Slack</strong> でも見えるようになったので今度は <a href="https://nature.global"><strong>Nature Remo</strong></a> と連携して気温や湿度での自動化ができたらいいな。</p>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:mackerel-token" role="doc-endnote">
      <p>https://mackerel.io/ja/api-docs/ <a href="#fnref:mackerel-token" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:slack-token" role="doc-endnote">
      <p>https://slack.com/intl/ja-jp/help/articles/215770388-API-%E3%83%88%E3%83%BC%E3%82%AF%E3%83%B3%E3%81%AE%E7%94%9F%E6%88%90%E3%81%A8%E5%86%8D%E7%94%9F%E6%88%90 <a href="#fnref:slack-token" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:slack-rs" role="doc-endnote">
      <p><a href="https://github.com/slack-rs/slack-rs">slack-rs</a> という便利ライブラリがあるのですが、ちょっと触ってみたこれは必要なんだっけ？となってやめました。 <a href="#fnref:slack-rs" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:hyper-warning" role="doc-endnote">
      <p><a href="https://github.com/hyperium/hyper#low-level">公式の README</a> にあるようにこの場合は <a href="https://github.com/seanmonstar/reqwest"><strong>reqwest</strong></a> を利用するほうがよかったかもしれない。<strong>TLS</strong> は直接 <strong>hyper</strong> が対応していなかったりしてすこし面倒です。 <a href="#fnref:hyper-warning" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>


<!-- Pagination links -->
<div class="pagination">
  
    <span class="previous">Previous</span>
  
  <span class="page_number ">
    Page: 1 of 11
  </span>
  
    <a href="/page/2/" class="next">Next</a>
  
</div>


      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">katsyoshi のめもみたいなの</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">katsyoshi のめもみたいなの</li><li><a class="u-email" href="mailto:web@katsyoshi.org">web@katsyoshi.org</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/katsyoshi"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">katsyoshi</span></a></li><li><a href="https://www.twitter.com/katsyoshi"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">katsyoshi</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>It&#39;s a memos.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
