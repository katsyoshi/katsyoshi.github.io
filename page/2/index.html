<!DOCTYPE html>
<html lang="en"><head><!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LQZYYM4LL2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LQZYYM4LL2');
</script>


<script>
  !function(o,e,n){var r=[];if(window.reproio)console.info("Repro Web SDK was loaded more than once");else{window.reproio=function(){r.push(arguments)};var i=o.createElement(e),t=o.getElementsByTagName(e)[0];i.src="https://cdn.reproio.com/web/v2/repro-sdk.min.js",i.async=!0,i.crossOrigin="",i.onload=function(){window.reproio("setSnippetVersion","2.1"),r.forEach(function(o){window.reproio.apply(window.reproio,o)})},t.parentNode.insertBefore(i,t)}}(document,"script");
  reproio("setup", "ff3c22fd-f7d1-4958-b16e-e57054f33d44");
  reproio("track", "pageView");
</script>
<meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Page 2 of 12 for katsyoshi のめもみたいなの - page 2 | katsyoshi のめもみたいなの</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="katsyoshi のめもみたいなの - page 2" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="It’s a memos." />
<meta property="og:description" content="It’s a memos." />
<link rel="canonical" href="https://blog.katsyoshi.org/page/2/" />
<meta property="og:url" content="https://blog.katsyoshi.org/page/2/" />
<meta property="og:site_name" content="katsyoshi のめもみたいなの" />
<meta property="og:type" content="website" />
<link rel="prev" href="https://blog.katsyoshi.org/" />
<link rel="next" href="https://blog.katsyoshi.org/page/3/" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="katsyoshi のめもみたいなの - page 2" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"It’s a memos.","headline":"katsyoshi のめもみたいなの - page 2","url":"https://blog.katsyoshi.org/page/2/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://blog.katsyoshi.org/feed.xml" title="katsyoshi のめもみたいなの" /></head>
<body><header class="site-header" role="banner">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">katsyoshi のめもみたいなの</a>
  </div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <!-- Pagination links -->
<div class="pagination">
  
    <a href="/" class="previous">
      Previous
    </a>
  
  <span class="page_number ">
    Page: 2 of 12
  </span>
  
    <a href="/page/3/" class="next">Next</a>
  
</div>



  <h1><a href="/blog/2022/10/15/goodbey-onamae-dot-com/">お名前ドットコムのメールがうざすぎたので DNS を Cloudflare に移行して快適生活</a></h1>
  <p class="author">
    <span class="date">2022-10-15 23:59:50 +0900</span>
  </p>
  <div class="content">
    <p><strong>katsyoshi.org</strong> の登録先を <a href="https://www.onamae.com"><strong>お名前ドットコム</strong></a> にしてたけど、広告のようなメールとか届くし
更新案内と広告の違いがわからない感じのメールが大量にくるのでやめようやめようと思ってたのでいいかげん変えてみた話。</p>

<h2 id="準備">準備</h2>

<p>準備として移行先のレジストラを選定します。
移行先としては普通のレジストラとクラウド業者がやっているレジストラがあると思いますが、今回は以下3つを候補にしました。</p>

<ol>
  <li><a href="https://domains.google/intl/ja_jp/"><strong>Google Domains</strong></a>: <strong>Google</strong> がやっているやつ。メールとか <strong>Google</strong> なんで <em>DNS</em> まで <strong>Google</strong> にするのは心理的抵抗が強い。</li>
  <li><a href="https://aws.amazon.com/jp/route53/"><strong>Route 53</strong></a>: みんなつかってる <strong>AWS</strong> のサービス。仕事で利用しているので、プライベートは別のがいいかな。</li>
  <li><a href="https://www.cloudflare.com/ja-jp/dns/"><strong>Cloudflare の DNS</strong></a>: みんなだいすき低価格 <em>CDN</em> 業者の <a href="https://cloudflare.com"><strong>Cloudflare</strong></a> がやってる <em>DNS</em> サービス。</li>
</ol>

<p><strong>Google</strong> 、 <strong>AWS</strong> は言わずと知れた巨大企業でサービスがなくなるということはないとおもうが、
仕事で利用したり、情報全部預けたりしているところなので選択する理由が個人的には弱い。
個人利用でガンガン変えたり、 <strong>VPC</strong> でネットワーク構築するわけじゃないので <strong>Cloudflare</strong> でいいかなと。</p>

<h3 id="お名前ドットコムでの作業">お名前ドットコムでの作業</h3>

<p>レジストラを移管する前に現在登録してある <a href="https://www.nic.ad.jp/ja/whois/">WHOIS 情報</a> を確認します。
これは移管作業で移管作業用コードが WHOIS 登録者にメールが送られてくるのでどのメールアドレスかの確認です。
ここで<a href="https://www.onamae.com/service/d-regist/option.html">WHOIS 情報公開代行</a> を利用している場合は、
WHOIS を一旦登録時のものに変更します<sup id="fnref:org" role="doc-noteref"><a href="#fn:org" class="footnote" rel="footnote">1</a></sup>。</p>

<h2 id="移管">移管</h2>

<p>移管作業としては新規レジストラで<a href="https://developers.cloudflare.com/registrar/get-started/transfer-domain-to-cloudflare/">移管依頼</a>を参考に移管依頼ページを開きます。
開いたら、旧サービスから移管コードの発行を行ないます<sup id="fnref:onamae" role="doc-noteref"><a href="#fn:onamae" class="footnote" rel="footnote">2</a></sup>。
移管コードを <a href="https://zenn.dev/a24k/articles/20220527-cloudflare-dns"><strong>Cloudflare</strong> 側で入力して</a>しばし待機。</p>

<p>しばらくしたら、レコードが登録されるので完了です。</p>

<h2 id="おわり">おわり</h2>

<p>ということで <em>DNS</em> の登録を <strong>Cloudflare</strong> へ移管しました。
<strong>お名前ドットコム</strong> はあのメールさえなければ続けたのかもしれない。
が更新警告と普通のメールの違いがあまりにもわからないので捨てることにしました。
<strong>Cloudflare</strong> で不満があったらまた変更すると思いますが、快適な生活になりました(たぶん</p>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:org" role="doc-endnote">
      <p>前に移行しようとしたとき、<strong>.org</strong> のドメインは WHOIS 情報書き変えられなくて移行失敗。現在この制限はなくなったので移行。 <a href="#fnref:org" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:onamae" role="doc-endnote">
      <p>こいつが見つけにくく、お名前ドットコムからは見つけられずに<a href="https://www.tsukimi.net/domain_onamae_xdomain.html">移管レポートブログ</a>から発見。 <a href="#fnref:onamae" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <h1><a href="/blog/2022/10/12/ipv6nize-at-home/">Communicate on IPv6 from home</a></h1>
  <p class="author">
    <span class="date">2022-10-12 23:59:50 +0900</span>
  </p>
  <div class="content">
    <p>家のネットワークからインターネットへ出るとき <code class="language-plaintext highlighter-rouge">IPoE</code> を使ってたけど、家庭内 LAN のネットワークは <code class="language-plaintext highlighter-rouge">IPv6</code> を off にしていた。
この LAN 内 <code class="language-plaintext highlighter-rouge">IPv6</code> 化していなかった理由としては、昔 Linux (だけじゃないかも)が <code class="language-plaintext highlighter-rouge">IPv6</code> が利用できる状態だと
先に <code class="language-plaintext highlighter-rouge">IPv6</code> で繋ぎにいこうとして <code class="language-plaintext highlighter-rouge">IPv6</code> で通信できなかったら <code class="language-plaintext highlighter-rouge">IPv4</code> にフォールバックするという挙動で、すごくストレスフルだった。
この挙動の対処として、カーネルレベルで <code class="language-plaintext highlighter-rouge">IPv6</code> を off にしてました。
そうこうしているうちに契約している ISP が <code class="language-plaintext highlighter-rouge">IPv6</code> オプションなしで <code class="language-plaintext highlighter-rouge">IPoE</code> を利用できるようになったので、
とりあえず <code class="language-plaintext highlighter-rouge">IPoE</code> だけを利用できるようにして、家庭内の LAN はそのままという状態にしていました。
いいかげんこの家庭内 LAN のネットワークを <code class="language-plaintext highlighter-rouge">IPv6</code> 化し、インターネットと <code class="language-plaintext highlighter-rouge">IPv6</code> で通信できるようにした顛末をのこす。のこします。</p>

<h2 id="家庭内-lan-環境">家庭内 LAN 環境</h2>

<ul>
  <li>ゲートウェイ: NEC IP38X/1210 (YAMAHA RTX1200)</li>
  <li>PC: 6.0.0-gentoo</li>
</ul>

<p><img src="/images/home2internet.png" alt="" /></p>

<h2 id="ipoe-化と家庭内-lan-の-ipv6-化">IPoE 化と家庭内 LAN の IPv6 化</h2>

<p>設定は <a href="https://network.yamaha.com/setting/router_firewall/flets/flets_other_service/ipv6_ipoe">YAMAHA の設定例集</a>に載ってあるのでそれを参考にします。
<code class="language-plaintext highlighter-rouge">IPoE</code> 化はこの設定例でいけるのですが、どうも設定したときにミスったらしく、 LAN の IP アドレスが <code class="language-plaintext highlighter-rouge">IPv4</code> ではインターネットへ出ることができるが、
<code class="language-plaintext highlighter-rouge">IPv6</code> ではインターネットへ出ることができない状態になってしまいました。</p>

<h3 id="旧設定">旧設定</h3>
<p>どのような設定だったかは以下に</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip route default gateway tunnel 1
ipv6 prefix 1 ra-prefix@lan2::/64
ipv6 lan1 address ra-prefix@lan2::1/64
ipv6 lan1 prefix ra-prefix@lan2::/64
ipv6 lan1 rtadv send 1
ipv6 lan1 dhcp service server
ipv6 lan2 address auto
ipv6 lan2 secure filter in 1010 1011 1012 2000
ipv6 lan2 secure filter out 3000 dynamic 100 101 102 103 104 105 106
ipv6 lan2 dhcp service client ir=on
ngn type lan2 ntt
tunnel select 1
 tunnel encapsulation ipip
 tunnel endpoint address 2404:8e00::feed:100
 tunnel enable 1
ipv6 filter 1010 pass * * icmp6 * *
ipv6 filter 1011 pass * * tcp * ident
ipv6 filter 1012 pass * * udp * 546
ipv6 filter 2000 reject * * * * *
ipv6 filter 3000 pass * * * * *
ipv6 filter dynamic 100 * * ftp
ipv6 filter dynamic 101 * * domain
ipv6 filter dynamic 102 * * www
ipv6 filter dynamic 103 * * smtp
ipv6 filter dynamic 104 * * pop3
ipv6 filter dynamic 105 * * tcp
ipv6 filter dynamic 106 * * udp
</code></pre></div></div>

<p>この設定ではインターネットとは <code class="language-plaintext highlighter-rouge">IPv4</code> でしか通信できていない状態でした。
でこのトラブルシュートとして知人(<a href="https://twitter.com/n_kane">@n_kane</a>, <a href="https://twitter.com/paina">@paina</a>) のちからを借りてどこまで通じてどこから通じないかを確認しました。</p>

<h3 id="troubleshooting">troubleshooting</h3>

<p>とりあえず <code class="language-plaintext highlighter-rouge">ping6</code> 、 <code class="language-plaintext highlighter-rouge">traceroute6</code> で通じていないことを確認します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ping6 -c 3 google.com

PING  google.com(nrt13s55-in-x0e.1e100.net (2404:6800:4004:824::200e)) 56 データ長(byte)

--- google.com ping 統計 ---
送信パケット数 3, 受信パケット数 0, パケット損失 100%, 時間 2067ミリ秒

$ traceroute6 google.com
traceroute to google.com, 30 hops max, 80 byte packets
 1  * * *
 2  * * *
 3  * * *
 4  * * *
 5  * * *
 6  * * *
 7  * * *
 8  * * *
 9  * * *
10  * * *
11  * * *
12  * * *
13  * * *
14  * * *
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  * * *
22  * * *
23  * * *
24  * * *
25  * * *
26  * * *
27  * * *
28  * * *
29  * * *
30  * * *
</code></pre></div></div>

<p>通ってないですね。
先述したように PC は <code class="language-plaintext highlighter-rouge">IPv6</code> を on にしたばかりなのでクライアント側の設定でブロックしていないかを確認します。
まずクライアント側で考えられるのは <code class="language-plaintext highlighter-rouge">iptables</code> でのパケットフィルタリングですね。
ルーターの下にある PC なので、ここでブロックすることは低いのですが、確認します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ip6tables --list
Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination
</code></pre></div></div>

<p>なにもフィルタリングしていないですね。
ということで、クライアント側には問題なさそうですね。
どこまで通じてどこまで通じていないのか別のエンドポイントで確認します。</p>

<p>まず、手元と相手で <code class="language-plaintext highlighter-rouge">tcpdump</code> 利用してパケットが送っているか届いているかを確認します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># tcpdump -nei enp8s0f0 icmp6
dropped privs to pcap
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on enp8s0f0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
22:35:41.158558 00:a0:de:69:40:9d &gt; 33:33:ff:51:5e:63, ethertype IPv6 (0x86dd), length 86: fe80::212:e2ff:fe70:6144 &gt; ff02::1:ff51:5e63: ICMP6, neighbor solicitation, who has 2409:10:a5c0:1f00:d903:ddb5:851:5e63, length 32
22:35:58.765783 ee:60:51:38:43:9c &gt; 33:33:ff:00:00:01, ethertype IPv6 (0x86dd), length 86: 2409:10:a5c0:1f00:5ce3:afcb:9bb2:5c1b &gt; ff02::1:ff00:1: ICMP6, neighbor solicitation, who has 2409:10:a5c0:1f00::1, length 32
22:36:09.249427 ee:60:51:38:43:9c &gt; 33:33:ff:00:00:01, ethertype IPv6 (0x86dd), length 86: 2409:10:a5c0:1f00:5ce3:afcb:9bb2:5c1b &gt; ff02::1:ff00:1: ICMP6, neighbor solicitation, who has 2409:10:a5c0:1f00::1, length 32
</code></pre></div></div>

<p>送れてはいるようで対向側にも届いていたらしく戻りのパケットは送ってたようですが、手元では戻ってくるパケットは見えていないですね。</p>

<p><img src="/images/ping6-failure.png" alt="" /></p>

<p>ということはやはりルーターの設定が悪そうということが推察されますね。
設定のどこが悪いのかあやしいところを見ていきます。</p>

<p>最初に怪しいとおもったのはルーターのフィルターまわりです。一旦、<code class="language-plaintext highlighter-rouge">no ipv6 interface secure filer in</code> で全部無効化しましょう。しかしとくに変りはないです。これはフィルターが原因ではなさそうですね。</p>

<p>次にあやしい点は以下2つの設定</p>

<ol>
  <li><a href="http://www.rtpro.yamaha.co.jp/RT/manual/rt-common/ipv6/ipv6_interface_address.html"><code class="language-plaintext highlighter-rouge">ipv6 interface address</code></a></li>
  <li><a href="http://www.rtpro.yamaha.co.jp/RT/manual/rt-common/ipv6/ipv6_interface_address.html"><code class="language-plaintext highlighter-rouge">ipv6 interface prefix</code></a></li>
</ol>

<p>上のコマンドは ISP から自動で振ってきている IP を割り当てる設定で、下のコマンドは ISP から振ってきた <code class="language-plaintext highlighter-rouge">IPv6</code> のプレフィックスを付けるようにするための設定となります。
どうもこの下のコマンドが邪魔なようです。
<code class="language-plaintext highlighter-rouge">no ipv6 interface prefix</code> で無効化できるので一旦外してみましょう。
すると</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ping6 -c 3 google.com
PING google.com(nrt20s18-in-x0e.1e100.net (2404:6800:4004:81c::200e)) 56 データ長(byte)
64 バイト応答 送信元 nrt20s18-in-x0e.1e100.net (2404:6800:4004:81c::200e): icmp_seq=1 ttl=57 時間=6.53ミリ秒
64 バイト応答 送信元 nrt20s18-in-x0e.1e100.net (2404:6800:4004:81c::200e): icmp_seq=2 ttl=57 時間=2.73ミリ秒
64 バイト応答 送信元 nrt20s18-in-x0e.1e100.net (2404:6800:4004:81c::200e): icmp_seq=3 ttl=57 時間=2.81ミリ秒

--- google.com ping 統計 ---
送信パケット数 3, 受信パケット数 3, パケット損失 0%, 時間 2002ミリ秒
rtt 最小/平均/最大/mdev = 2.731/4.023/6.532/1.773ミリ秒
</code></pre></div></div>

<p>のように通りました!勝ったッ!第三部完!</p>

<h2 id="おわり">おわり</h2>

<p>以前中途半端に設定したおかげで <code class="language-plaintext highlighter-rouge">IPv6</code> 有効化に時間が掛ってしまった顛末をまとめました。
これで家のネットワークから <code class="language-plaintext highlighter-rouge">IPv6</code> で通信できるようになりました。
ありがとうございました!</p>

<p>次回 katsyoshi.org お名前.COM やめるってよ</p>

  </div>

  <h1><a href="/blog/2022/09/11/had-lovely-days-at-rubykaigi-2022/">RubyKaigi 最高！</a></h1>
  <p class="author">
    <span class="date">2022-09-11 23:59:50 +0900</span>
  </p>
  <div class="content">
    <p><a href="https://rubykaigi.org/2022">RubyKaigi 2022</a> に行ってきました! ので感想を</p>

<h2 id="day-0">DAY 0</h2>

<p>今回も <a href="https://yancya.house/">やんちゃハウス</a> に楽をして泊まることにしてたのでなにも気にせず宿へ。
着いて他メンバーが来るまで宿で待機してたが、最寄り駅の周りが思った以上になにもなく、途方に暮れてました。</p>

<h4 id="夕飯">夕飯</h4>

<p>もうひとり宿に着いたので入れ変わりで夕飯へ出かけたが、そもそも最寄り駅前にはなにもないので伊勢駅まで出ることにした。</p>

<p>この判断が間違えてたようで、伊勢駅に出てもとくに変らなかった。しかし幸い伊勢駅前に担々麺屋があったのでそこで食料摂取した。</p>

<h2 id="day-1">DAY 1</h2>

<p>この日の聞いたセトリと感想は以下のとおり</p>

<h4 id="ruby-meets-webassembly-presentation"><a href="https://rubykaigi.org/2022/presentations/kateinoigakukun.html">Ruby meets WebAssembly</a>: <a href="">presentation</a></h4>

<p>この日のキーノートは <a href="https://www.ruby-lang.org/"><code class="language-plaintext highlighter-rouge">Ruby</code></a> の <a href="https://webassembly.org/"><code class="language-plaintext highlighter-rouge">wasm</code></a> 対応の話で <a href="https://wasi.dev/"><code class="language-plaintext highlighter-rouge">wasi</code></a> を通じてブラウザで <code class="language-plaintext highlighter-rouge">Ruby</code> が動かすまでのたのしいことをしゃべってたようです。
おなかいたくてトイレ行ってたら面白いところ聞き逃がしてしまった。</p>

<h4 id="ランチ">ランチ</h4>
<p>適当に幕の内弁当を最初に選択。</p>

<h4 id="making-many-threads-on-ruby-presentation"><a href="https://rubykaigi.org/2022/presentations/ko1.html">Making *MaNy* threads on Ruby</a>: <a href="">presentation</a></h4>

<p>笹田さんの発表で如何に <code class="language-plaintext highlighter-rouge">Ruby</code> で CPU をフルに使えるようにするかの話。 <code class="language-plaintext highlighter-rouge">Ruby</code> での <code class="language-plaintext highlighter-rouge">Thread</code> のはなしから <a href="https://github.com/ruby/ruby/blob/master/doc/ractor.md"><code class="language-plaintext highlighter-rouge">Ractor</code></a> を利用してフルフルに CPU 利用するための書きかたとかの話していました。</p>

<h4 id="building-a-lightweight-ir-and-backend-for-yjit-presentation"><a href="https://rubykaigi.org/2022/presentations/maximecb.html">Building a Lightweight IR and Backend for YJIT</a>: <a href="">presentation</a></h4>

<p><code class="language-plaintext highlighter-rouge">Ruby 3.1</code> で <a href="https://github.com/Shopify/yjit"><code class="language-plaintext highlighter-rouge">YJIT</code></a> が入って <code class="language-plaintext highlighter-rouge">Ruby 3.2</code> でサポートされる CPU アーキテクチャが増えたはなし。RubyVM(？) に <code class="language-plaintext highlighter-rouge">YJIT</code> 用 <code class="language-plaintext highlighter-rouge">Ruby IR</code> を作成して <code class="language-plaintext highlighter-rouge">JIT</code> を実行するという話。
聞いてて疑問になった点としては、 <code class="language-plaintext highlighter-rouge">Ruby IR</code> では直接機械語に翻訳しているようだったが、このバックエンドに <a href="https://llvm.org"><code class="language-plaintext highlighter-rouge">LLVM</code></a> を利用していないのはなんでなんだろう。聞き逃がしているという話はあるので、詳しいひと教えて。</p>

<h4 id="tools-for-providing-rich-user-experience-in-debugger-presentation"><a href="https://rubykaigi.org/2022/presentations/ono-max.html">Tools for Providing rich user experience in debugger</a>: <a href="">presentation</a></h4>

<p><a href="https://github.com/ruby/debug"><code class="language-plaintext highlighter-rouge">debug.gem</code></a> を <a href="https://code.visualstudio.com/"><code class="language-plaintext highlighter-rouge">VS Code</code></a> だけじゃなく、 <a href="https://www.google.com/intl/ja_jp/chrome/"><code class="language-plaintext highlighter-rouge">Chrome</code></a> のリモートデバッグ機能を利用したデバッグの話でした。
この機能自体はすごく便利だと思うのですが、そもそも両方とも宗教上の理由で利用できない体なので聞くだけでした。</p>

<h4 id="trick-2022-returns-repos"><a href="https://rubykaigi.org/2022/presentations/tric.html">TRICK 2022 (Returns)</a>: <a href="">repos</a></h4>

<p>いつも通り <del>変な</del> エキセントリックなプログラムしか出てこなかったし、いつもの面子が賞もらってたのですごいなーという感想。</p>

<h4 id="夕飯-1">夕飯</h4>

<p>この日は津駅があまりなさそうだったので、駅近くで飲むのではなく、宿寄りの場所松坂駅で飲むことにした。
ここで、津の夜情報を聞き込んだり、朝ごはん情報自体を仕入れてました。</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">昨日の夕飯 <a href="https://twitter.com/hashtag/rubykaigi?src=hash&amp;ref_src=twsrc%5Etfw">#rubykaigi</a> <a href="https://t.co/G8lmetYX9J">pic.twitter.com/G8lmetYX9J</a></p>&mdash; katsyoshi (@katsyoshi) <a href="https://twitter.com/katsyoshi/status/1568012256566480896?ref_src=twsrc%5Etfw">September 8, 2022</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<h2 id="day-2">DAY 2</h2>
<p>2日目は、ネットワークが不安定になったりしてこちらの集中力が切れたりしたのであまり覚えていない。</p>

<h4 id="朝ごはん">朝ごはん</h4>

<p>前日の夕飯に教えてもらった市場の人向け食堂が松坂駅前にあり、その食堂で食事をした。</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">朝メッシ <a href="https://twitter.com/hashtag/rubykaigi?src=hash&amp;ref_src=twsrc%5Etfw">#rubykaigi</a> <a href="https://t.co/PvbaUrRUIf">pic.twitter.com/PvbaUrRUIf</a></p>&mdash; katsyoshi (@katsyoshi) <a href="https://twitter.com/katsyoshi/status/1568019085430259712?ref_src=twsrc%5Etfw">September 8, 2022</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<h4 id="matz-keynote-presentation"><a href="https://rubykaigi.org/2022/presentations/yukihiro_matz.html">Matz Keynote</a>: <a href="">presentation</a></h4>

<h4 id="do-pure-ruby-dream-of-encrypted-binary-protocol-presentation"><a href="https://rubykaigi.org/2022/presentations/yu_suke1994.html">Do Pure Ruby Dream of Encrypted Binary Protocol?</a>: <a href="">presentation</a></h4>

<p>ノーコメント。</p>

<h4 id="ランチ-1">ランチ</h4>

<p>この日も一番に弁当を取得。弁当はみんな大好き松坂牛ローストビーフ丼にした。感想としては、もう肉はいいかな。</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">昼飯　<a href="https://twitter.com/hashtag/rubykaigi?src=hash&amp;ref_src=twsrc%5Etfw">#rubykaigi</a> <a href="https://t.co/vpOf6Uwf0K">pic.twitter.com/vpOf6Uwf0K</a></p>&mdash; katsyoshi (@katsyoshi) <a href="https://twitter.com/katsyoshi/status/1568070622210826240?ref_src=twsrc%5Etfw">September 9, 2022</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<h4 id="自キkaigi">自キKaigi</h4>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">きょうも <a href="https://twitter.com/hashtag/%E8%87%AA%E3%82%ADKaigi?src=hash&amp;ref_src=twsrc%5Etfw">#自キKaigi</a> やります。ランチ食べたらスポンサーエリアの手前あたりにお集まりください <a href="https://twitter.com/hashtag/rubykaigi?src=hash&amp;ref_src=twsrc%5Etfw">#rubykaigi</a></p>&mdash; 🇺🇦hasumikin🇺🇦 (@hasumikin) <a href="https://twitter.com/hasumikin/status/1568023525407211521?ref_src=twsrc%5Etfw">September 8, 2022</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>誘われたので参加しました。iPad で活動しようと思い <a href="https://github.com/foostan/crkbd">corne</a> 持っていってたので参加してた。</p>

<h4 id="ruby-x-bpf-in-action-how-important-observability-is-presentation"><a href="https://rubykaigi.org/2022/presentations/udzura.html">Ruby x BPF in Action: How important observability is</a>: <a href="">presentation</a></h4>
<h4 id="hunting-production-memory-leaks-with-heap-sampling-presentation"><a href="https://rubykaigi.org/2022/presentations/KnuX.html">Hunting Production Memory Leaks with Heap Sampling</a>: <a href="">presentation</a></h4>
<p>このあたりネットワークが不安定になり、セッションが中断されたりしたためあまり覚えていない。</p>

<h4 id="立ち話">立ち話</h4>

<p>久し振りの対面での参加だったのでセッションあまり聞かずに受け付け前で立ち話している人たちがいたので、その立ち話に参加した。
たまたま、最近読んでる本の翻訳者がいたのでこれからの話などを聞いたりしていた。</p>

<h4 id="caching-with-messagepack-presentation"><a href="https://rubykaigi.org/2022/presentations/shioyama.html">Caching With MessagePack</a>: <a href="">presentation</a></h4>
<h4 id="ruby-committers-vs-the-world"><a href="https://rubykaigi.org/2022/presentations/rubylangorg.html">Ruby Committers vs The World</a></h4>

<h4 id="夕飯-2">夕飯</h4>

<p>夕飯は、駅近くのお店でかるく3人で。</p>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">いまどこ</p>&mdash; tagomoris (@tagomoris) <a href="https://twitter.com/tagomoris/status/1568221035702685696?ref_src=twsrc%5Etfw">September 9, 2022</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>こんなリプライがきてたようなので一緒にいたひとにまかせた。ギリギリまで粘ってたので帰宿後すぐ就寝。</p>

<h2 id="day-3">DAY 3</h2>

<p>3日目はそもそも前2日の疲れが出たりしたのかほとんど覚えていない。あと <a href="https://ruby-puzzles-2022.cookpad.tech/">ruby puzzle</a> をやっていてセッションをあまり聞けていない。</p>

<h4 id="朝ごはん-1">朝ごはん</h4>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">今日も一日 <a href="https://twitter.com/hashtag/rubykaigi?src=hash&amp;ref_src=twsrc%5Etfw">#rubykaigi</a> <a href="https://t.co/PKnj8sHxwE">pic.twitter.com/PKnj8sHxwE</a></p>&mdash; katsyoshi (@katsyoshi) <a href="https://twitter.com/katsyoshi/status/1568387387088322560?ref_src=twsrc%5Etfw">September 9, 2022</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<h4 id="megaruby---running-mrubyc-programs-on-sega-mega-drive-presentation"><a href="https://rubykaigi.org/2022/presentations/yujiyokoo.html">Megaruby - Running mruby/c programs on Sega Mega Drive</a>: <a href="">presentation</a></h4>

<p>これに間に合うように出たはずだったが、間に合わず聞いていた。メガドライブすげえ。</p>

<h4 id="automatically-find-memory-leaks-in-native-gems-presentation"><a href="https://rubykaigi.org/2022/presentations/peterzhu2118.html">Automatically Find Memory Leaks in Native Gems</a>: <a href="">presentation</a></h4>
<h4 id="fast-data-processing-with-ruby-and-apache-arrow-presentation"><a href="https://rubykaigi.org/2022/presentations/ktou.html">Fast data processing with Ruby and Apache Arrow</a>: <a href="">presentation</a></h4>
<h4 id="fixing-assignment-evaluation-order-presentation"><a href="https://rubykaigi.org/2022/presentations/jeremyevans0.html">Fixing Assignment Evaluation Order</a>: <a href="">presentation</a></h4>
<h4 id="stories-from-developing-yjit-presentation"><a href="https://rubykaigi.org/2022/presentations/alanwusx.html">Stories from developing YJIT</a>: <a href="">presentation</a></h4>

<h2 id="まとめ">まとめ</h2>

<p>3年ぶりの現地開催だったので参加してきました。対面での参加はやはりよいもので新しい出会いや、疑問を本人、解っている人に直接聞くことができてすばらしい体験でした。</p>

<h3 id="三重について">三重について</h3>
<p>三重県の酒のイメージは、行く前は「作」「 而今」「伊勢角谷屋麦酒」というイメージでした。
とくに日本酒は美味しいイメージがあり、知らない日本酒もあったりするんだろうなあと思っていました。
行ってみると日本酒はイメージと変わらないのですが、だいたい似た味の傾向で飽きるというかなんというか
美味しいんだけど、好きじゃないという感想になってしまった。
ビールについては瓶ビールしか飲まなかったので感想はなしで。</p>

<p>三重は大きな街が比較的分散しているようで、津も松坂も伊勢も鳥羽も駅前が小さく感じました。
とくに0日目の食事が大変で、調達が難しかった。</p>

  </div>

  <h1><a href="/blog/2022/08/12/how-to-use-rust-in-ruby-gems/">Ruby gem で Rust をつかって爆速にしたい!!!!!!11</a></h1>
  <p class="author">
    <span class="date">2022-08-12 13:59:59 +0900</span>
  </p>
  <div class="content">
    <p><a href="https://rubygems.org">Ruby Gems</a> で <a href="https://www.rust-lang.org">Rust</a> が <a href="https://github.com/rubygems/rubygems/pull/5175">Native として利用可能になった</a> のでとりあえず <a href="https://www.rfc-editor.org/rfc/rfc4122.html"><code class="language-plaintext highlighter-rouge">UUIDv4</code></a> を生成してみた。</p>

<h3 id="リポジトリ">リポジトリ</h3>
<p><a href="https://github.com/katsyoshi/rust_uuid"><img src="https://gh-card.dev/repos/katsyoshi/rust_uuid.svg" alt="katsyoshi/rust_uuid - GitHub" /></a></p>

<h2 id="準備">準備</h2>

<p>Ruby 側の <code class="language-plaintext highlighter-rouge">gem</code> に Rust を利用する準備として <a href="https://github.com/oxidize-rb/rb-sys"><code class="language-plaintext highlighter-rouge">rb_sys</code></a> と <a href="https://github.com/rake-compiler/rake-compiler"><code class="language-plaintext highlighter-rouge">rake-compiler</code></a> を利用します。この二つの <code class="language-plaintext highlighter-rouge">gem</code> は native compile するためにインストールしておきます。
Rust 側から Ruby へ関数を公開するために <a href="https://github.com/oxidize-rb/rb-sys"><code class="language-plaintext highlighter-rouge">rb-sys</code></a> と <a href="https://github.com/matsadler/magnus"><code class="language-plaintext highlighter-rouge">magnus</code></a> を利用します。</p>

<h2 id="gem-install">gem install</h2>

<p>とりあえず <code class="language-plaintext highlighter-rouge">cargo</code> で Rust のパッケージを作って Rust を書いてみます。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> bundle gem rust_uuid <span class="nt">--mit</span> <span class="nt">--ext</span> rust_uuid <span class="c"># --ext を指定してnative build する gem を作成</span>
<span class="o">&gt;</span> <span class="nb">cd </span>rust_uuid <span class="c"># 作成した gem のディレクトリへ移動</span>
<span class="o">&gt;</span> <span class="nb">cd </span>ext/rust_uuid <span class="c"># ビルドするディレクトリへ移動</span>
<span class="o">&gt;</span> cargo init <span class="nb">.</span> <span class="nt">--lib</span> <span class="c"># cargo を初期化</span>
<span class="o">&gt;</span> <span class="nb">rm</span> <span class="nt">-f</span> <span class="k">*</span>.c <span class="k">*</span>.h <span class="c"># C のファイルが生成されるので削除</span>
<span class="o">&gt;</span> cargo add rb-sys rb-allocator
<span class="o">&gt;</span> cargo add magnus <span class="nt">--features</span> rb-sys-interop
<span class="o">&gt;</span> cargo add uuid <span class="nt">--features</span> v4 <span class="c"># uuid v4 を指定</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ext/rust_uuid/extconf.rb</code> を以下のように編集します。</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@@ -1,5 +1,6 @@</span>
 # frozen_string_literal: true
 
 require "mkmf"
<span class="gi">+require "rb_sys/mkmf"
</span> 
<span class="gd">-create_makefile("rust_uuid/rust_uuid")
</span><span class="gi">+create_rust_makefile("rust_uuid/rust_uuid")
</span></code></pre></div></div>

<p>次に <code class="language-plaintext highlighter-rouge">ext/rust_uuid/src/lib.rs</code> を以下の様に変更します。</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">magnus</span><span class="p">::{</span><span class="n">define_module</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="nn">prelude</span><span class="p">::</span><span class="o">*</span><span class="p">,</span> <span class="n">Error</span><span class="p">};</span>
<span class="k">use</span> <span class="nn">rb_allocator</span><span class="p">::</span><span class="n">ruby_global_allocator</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">uuid</span><span class="p">::</span><span class="n">Uuid</span><span class="p">;</span>

<span class="nd">ruby_global_allocator!</span><span class="p">();</span>

<span class="c1">// UUIDv4 を文字列として公開</span>
<span class="k">fn</span> <span class="nf">v4</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">String</span> <span class="p">{</span>
    <span class="nn">Uuid</span><span class="p">::</span><span class="nf">new_v4</span><span class="p">()</span><span class="nf">.to_string</span><span class="p">()</span>
<span class="p">}</span>

<span class="nd">#[magnus::init]</span>
<span class="k">fn</span> <span class="nf">init</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">module</span> <span class="o">=</span> <span class="nf">define_module</span><span class="p">(</span><span class="s">"RustUUID"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="c1">// RustUUID.v4 と利用するようにシングルトンメソッドを定義</span>
    <span class="n">module</span><span class="nf">.define_singleton_method</span><span class="p">(</span><span class="s">"v4"</span><span class="p">,</span> <span class="nd">function!</span><span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div></div>

<p>これまでできたら一旦 Rust をコンパイルしましょう。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">cd </span>ext/rust_uuid
<span class="o">&gt;</span> cargo build
<span class="o">&gt;</span> git add <span class="nb">.</span>
<span class="o">&gt;</span> rake build
.... <span class="c"># install cargo dependencies and packages</span>
<span class="nb">cp</span>: <span class="s1">'/home/katsyoshi/Program/Ruby/rust_uuid/tmp/x86_64-linux/rust_uuid/3.1.2/target/release/librust_uuid.so'</span> を <span class="nb">stat </span>できません: そのようなファイルやディレクトリはありません
gmake: <span class="k">***</span> <span class="o">[</span>Makefile:551: foo_bar.so] エラー 1
rake aborted!
Command failed with status <span class="o">(</span>2<span class="o">)</span>: <span class="o">[</span>/usr/bin/gmake...]

Tasks: TOP <span class="o">=&gt;</span> build <span class="o">=&gt;</span> compile <span class="o">=&gt;</span> compile:x86_64-linux <span class="o">=&gt;</span> compile:foo_bar:x86_64-linux <span class="o">=&gt;</span> copy:rust_uuid:x86_64-linux:3.1.2 <span class="o">=&gt;</span> tmp/x86_64-linux/rust_uuid/3.1.2/rust_uuid.so
</code></pre></div></div>

<p>とエラーになります。
これは <code class="language-plaintext highlighter-rouge">ext/rust_uuid/Cargo.toml</code> の設定が足りていません。そこで以下を追加してみてください。</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[lib]</span>
<span class="py">crate-type</span> <span class="p">=</span> <span class="p">[</span><span class="s">"cdylib"</span><span class="p">]</span>
</code></pre></div></div>

<p>追加したら <code class="language-plaintext highlighter-rouge">gem</code> をビルド&amp;&amp;インストール&amp;&amp;試してみましょう!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> rake <span class="nb">install</span>
....
<span class="o">&gt;</span> ruby <span class="nt">-rrust_uuid</span> <span class="nt">-e</span> <span class="s1">'puts RustUUID.v4'</span>
2be6f4d2-200b-4d08-9a1a-11fa523b316b
</code></pre></div></div>

<h2 id="べんちまーく">べんちまーく</h2>

<p>以下、 <code class="language-plaintext highlighter-rouge">SecureRandom.uuid</code> との比較用のベンチマークコードを示します。</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"benchmark/ips"</span>
<span class="nb">require</span> <span class="s2">"securerandom"</span>
<span class="nb">require</span> <span class="s2">"rust_uuid"</span>

<span class="no">Benchmark</span><span class="p">.</span><span class="nf">ips</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"standard"</span><span class="p">)</span> <span class="p">{</span> <span class="no">SecureRandom</span><span class="p">.</span><span class="nf">uuid</span> <span class="p">}</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"rust lib"</span><span class="p">)</span> <span class="p">{</span> <span class="no">RustUUID</span><span class="p">.</span><span class="nf">v4</span> <span class="p">}</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">compare!</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="結果発表">結果発表〜</h3>

<p>Rust を利用することでだいたい 5 倍ほど速くなっています。</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">&gt;</span><span class="w"> </span>ruby bentimark.rb
<span class="go">Warming up --------------------------------------
            standard    36.437k i/100ms
            rust lib   177.585k i/100ms
Calculating -------------------------------------
            standard    365.407k (± 1.4%) i/s -      1.858M in   5.086491s
            rust lib      1.793M (± 1.8%) i/s -      9.057M in   5.053179s

Comparison:
            rust lib:  1792925.9 i/s
            standard:   365407.3 i/s - 4.91x  (± 0.00) slower

ruby bentimark.rb  9.88s user 4.30s system 99% cpu 14.175 total
</span></code></pre></div></div>

<p>TOO HAYAI</p>

<h2 id="まとめ">まとめ</h2>
<p>簡単に Rust を利用して速くしてみました。
思った以上に速くなっていたので重い処理をする場合に <code class="language-plaintext highlighter-rouge">C</code> や <code class="language-plaintext highlighter-rouge">C++</code> 以外でも簡単に利用できるようになって
選択肢が増えたのはよいことでした。</p>

<p>実はこの <code class="language-plaintext highlighter-rouge">uuid</code> crate の features に <code class="language-plaintext highlighter-rouge">fast-rng</code> を追加すると 10 倍速くなるんですが、 ruby 側の終了時に <code class="language-plaintext highlighter-rouge">SEGV</code> してしまうので載せていないです。 <code class="language-plaintext highlighter-rouge">SEGV</code> しないように原因を調査などはまた今度。</p>

  </div>

  <h1><a href="/blog/2022/03/19/hello-wezterm/">Hello, Wezterm</a></h1>
  <p class="author">
    <span class="date">2022-03-19 18:00:00 +0900</span>
  </p>
  <div class="content">
    <p><a href="https://github.com/tmux/tmux"><code class="language-plaintext highlighter-rouge">tmux</code></a> + <a href="https://github.com/tmux/tmux"><code class="language-plaintext highlighter-rouge">Allacritty</code></a> が疲れてきたので<a href="https://zenn.dev/yutakatay/articles/wezterm-intro">はてぶで流れてきた</a> <a href="https://github.com/wez/wezterm"><code class="language-plaintext highlighter-rouge">wezterm</code></a> が <a href="https://github.com/saitoha/libsixel"><code class="language-plaintext highlighter-rouge">sixel</code></a> を利用できてよさそうだったので試してみることにした。</p>

<h2 id="設定">設定</h2>

<p>設定ファイルが <a href="https://www.lua.org/">lua</a> でカスタマイズがいろいろとできるのでまずは色を代えてみます。</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">wezterm</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">'wezterm'</span>
<span class="k">return</span> <span class="p">{</span>
  <span class="n">color_scheme</span> <span class="o">=</span> <span class="s2">"Dracula"</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>プログラミング言語でカスタマイズができるので以下のようにアクティブなタブへの移動のキーバインドのカスタマイズができます。</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">wezterm</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">'wezterm'</span>
<span class="kd">local</span> <span class="n">move_keys</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">9</span> <span class="k">do</span>
   <span class="nb">table.insert</span><span class="p">(</span><span class="n">move_keys</span><span class="p">,</span> <span class="p">{</span>
      <span class="n">key</span> <span class="o">=</span> <span class="nb">tostring</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
      <span class="n">mods</span> <span class="o">=</span> <span class="s2">"CTRL"</span><span class="p">,</span>
      <span class="n">action</span> <span class="o">=</span> <span class="n">wezterm</span><span class="p">.</span><span class="n">action</span><span class="p">{</span> <span class="n">ActivateTab</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
   <span class="p">})</span>
<span class="k">end</span>

<span class="k">return</span> <span class="p">{</span>
   <span class="n">color_scheme</span> <span class="o">=</span> <span class="s2">"Dracula"</span><span class="p">,</span>
   <span class="n">disable_default_key_bindings</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">-- 初期のキーバインドは利用しない場合</span>
   <span class="n">keys</span> <span class="o">=</span> <span class="n">move_keys</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>こんな感じで設定できるので便利です。</p>

<p>このキーバインドは任意のイベントも設定でき、任意のイベントを利用してアクションを定義できます。以下の例では、Paneを開い監視用のプログラムを開きます。</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">wezterm</span> <span class="o">=</span> <span class="nb">require</span> <span class="s1">'wezterm'</span>
<span class="n">wezterm</span><span class="p">.</span><span class="n">on</span><span class="p">(</span><span class="s2">"open-nvtop-and-ytop"</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">pane</span><span class="p">)</span>
   <span class="n">win</span><span class="p">:</span><span class="n">perform_action</span><span class="p">(</span><span class="n">wezterm</span><span class="p">.</span><span class="n">action</span><span class="p">{</span> <span class="n">SplitHorizontal</span> <span class="o">=</span> <span class="p">{</span> <span class="n">domain</span> <span class="o">=</span> <span class="s2">"CurrentPaneDomain"</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"nvtop"</span><span class="p">,</span> <span class="p">},</span> <span class="p">},</span> <span class="p">},</span> <span class="n">pane</span><span class="p">)</span>
   <span class="n">win</span><span class="p">:</span><span class="n">perform_action</span><span class="p">(</span><span class="n">wezterm</span><span class="p">.</span><span class="n">action</span><span class="p">{</span> <span class="n">SplitVertical</span> <span class="o">=</span> <span class="p">{</span> <span class="n">domain</span> <span class="o">=</span> <span class="s2">"CurrentPaneDomain"</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">"ytop"</span><span class="p">,</span> <span class="s2">"-ps"</span><span class="p">,</span> <span class="p">},</span> <span class="p">},</span> <span class="p">},</span> <span class="n">pane</span><span class="p">)</span>
<span class="k">end</span><span class="p">)</span>

<span class="k">return</span> <span class="p">{</span>
   <span class="n">keys</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="n">key</span> <span class="o">=</span> <span class="s2">"r"</span><span class="p">,</span> <span class="n">mods</span> <span class="o">=</span> <span class="s2">"CTRL"</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">wezterm</span><span class="p">.</span><span class="n">action</span><span class="p">{</span> <span class="n">EmitEvent</span> <span class="o">=</span> <span class="s2">"open-nvtop-and-ytop"</span><span class="p">,</span> <span class="p">},</span> <span class="p">},</span> <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div>

<p>とすると以下のようになります。
<img src="/images/screenshot/open-nvtop-and-ytop-in-wezterm.png" width="100%" />
便利!</p>

<p>こんな便利なものということで <code class="language-plaintext highlighter-rouge">systemd</code> でデーモン化しています。</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[Unit]</span>
<span class="py">Description</span><span class="p">=</span><span class="err">GUI</span> <span class="err">Accellarated</span> <span class="err">terminal</span>
<span class="py">Documentation</span><span class="p">=</span>

<span class="nn">[Service]</span>
<span class="py">Type</span><span class="p">=</span><span class="err">forking</span>
<span class="py">ExecStart</span><span class="p">=</span><span class="err">/usr/local/bin/wezterm-mux-server</span> <span class="err">--daemonize</span>
<span class="py">Restart</span><span class="p">=</span><span class="err">on-failure</span>

<span class="nn">[Install]</span>
<span class="py">WantedBy</span><span class="p">=</span><span class="err">default.target</span>
</code></pre></div></div>

<p>で起動しておいています</p>

<h3 id="問題点">問題点</h3>

<p>と設定ファイルの例書いてみたのですが、とても大きな問題点にブチあたったので書いておきます。</p>

<p><code class="language-plaintext highlighter-rouge">wezterm</code> には <code class="language-plaintext highlighter-rouge">wezterm-mux-server</code> というマルチプレクサ(tmuxのように扱うため)のサーバーモードプログラムがあるのですが、こいつがどうも <code class="language-plaintext highlighter-rouge">wezterm</code> とは挙動が異なり、前述した監視用のキーバインドが微妙に異なった挙動となってしまっています。サーバーモードに接続した場合の挙動は以下のようになります。</p>

<p><img src="/images/screenshot/failed-nvtop-ytop.png" width="100%" /></p>

<p>1つ目はpaneの位置が期待したとおりになっていない。2つ目は <code class="language-plaintext highlighter-rouge">ytop</code> が起動していないというので2つ目の方は気にしなければいいのでまあいいかと思っている。1つ目の問題は許容できていないので一旦はこのキーバインドは封印となっています。</p>

<h1 id="おわり">おわり</h1>

<p>長年利用してた <code class="language-plaintext highlighter-rouge">tmux</code> を捨てて <code class="language-plaintext highlighter-rouge">wezterm</code> を利用しはじめた。
設定が <code class="language-plaintext highlighter-rouge">lua</code> で書けるのが体験的にとても良いのでこれからも利用するかなと。
<code class="language-plaintext highlighter-rouge">wezterm</code> で <code class="language-plaintext highlighter-rouge">sixel</code> 利用した画像表示ができるようになったのが便利なので「よしっ！」</p>


  </div>

  <h1><a href="/blog/2022/01/03/hello-2022/">冬やすみ</a></h1>
  <p class="author">
    <span class="date">2022-01-03 23:59:59 +0900</span>
  </p>
  <div class="content">
    <p>冬やすみの間、やりたいこと、やっといたほうがいいやつをやってました。
ひとつは <a href="/blog/2021/12/26/xremap/">xremap</a> の設定ともうひとつは <a href="/blog/2021/12/30/custom-co2mini-co2-sensor/">CO2-mini から CO<sub>2</sub> を見える</a> ようにした。</p>

<p>今回は、 <a href="https://mackerel.io"><strong>mackerel</strong></a> で見えるようになった <strong>CO<sub>2</sub></strong> の値を <strong>Slack</strong> へ定期的に投げるようにします。今回も <a href="https://www.rust-lang.org"><strong>Rust</strong></a> を利用しています。</p>

<h2 id="準備">準備</h2>

<p>準備として、 <strong>mackerel</strong> <sup id="fnref:mackerel-token" role="doc-noteref"><a href="#fn:mackerel-token" class="footnote" rel="footnote">1</a></sup> と <strong>Slack</strong> <sup id="fnref:slack-token" role="doc-noteref"><a href="#fn:slack-token" class="footnote" rel="footnote">2</a></sup>
両アプリケーションの投稿 API 用 Token をそれぞれ用意します。
各公式ページにあるように生成、取得するだけでよいです。</p>

<p><strong>mackerel</strong> 側は <a href="https://mackerel.io/ja/api-docs/entry/host-metrics#get">ホストメトリック API</a> を利用します。
<strong>Slack</strong> 側は <a href="https://api.slack.com/methods/chat.postMessage">chat.postMessage API</a> を利用します。
各 API に対して取得した API Token を用いて <code class="language-plaintext highlighter-rouge">curl</code> で確認しておきます。</p>

<h2 id="実装">実装</h2>

<p>今回は対話式の <strong>bot</strong> ではないので、 <a href="https://api.slack.com/rtm"><strong>RTM</strong></a> を利用せずに、<strong>HTTP</strong> クライアントだけで構成しています<sup id="fnref:slack-rs" role="doc-noteref"><a href="#fn:slack-rs" class="footnote" rel="footnote">3</a></sup>。
<strong>Rust</strong> の <strong>HTTP</strong> クライアントとして <a href="https://github.com/hyperium/hyper"><strong>hyper</strong></a><sup id="fnref:hyper-warning" role="doc-noteref"><a href="#fn:hyper-warning" class="footnote" rel="footnote">4</a></sup> を利用します。
<strong>TLS</strong> は <a href="https://github.com/hyperium/hyper-tls"><strong>hyper_tls</strong></a> を利用しています。</p>

<p>実装とは言っても対象の <strong>mackerel</strong> の APIを叩き値を取得して、
その値を元に <strong>Slack</strong> へポストするだけです。</p>

<p><strong>mackerel</strong> での値取得時に気をつける点としては、<strong>ホストメトリック API</strong> では <code class="language-plaintext highlighter-rouge">host名</code> ではなく、
<code class="language-plaintext highlighter-rouge">host id</code> がパラメーターとなっていますので注意が必要です。
まずレスポンスを入れる構造体を定義します。</p>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[derive(Deserialize)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">Metric</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">time</span><span class="p">:</span> <span class="nb">i64</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">value</span><span class="p">:</span> <span class="nb">i16</span><span class="p">,</span> <span class="c1">// 今回は co2 の値なので i16 としている</span>
<span class="p">}</span>

<span class="nd">#[derive(Deserialize)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">ResponseMetrics</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">metrics</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Metric</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>つぎに以下のようにしてリクエストを組みたてて、値を取得しています。</p>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">https</span> <span class="o">=</span> <span class="nn">HttpsConnector</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
<span class="k">let</span> <span class="n">req</span> <span class="o">=</span> <span class="nn">hyper</span><span class="p">::</span><span class="nn">Request</span><span class="p">::</span><span class="nf">builder</span><span class="p">()</span>
    <span class="nf">.method</span><span class="p">(</span><span class="nn">hyper</span><span class="p">::</span><span class="nn">Method</span><span class="p">::</span><span class="n">GET</span><span class="p">)</span>
    <span class="nf">.uri</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="nf">.header</span><span class="p">(</span><span class="s">"X-Api-Key"</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
    <span class="nf">.body</span><span class="p">(</span><span class="nn">hyper</span><span class="p">::</span><span class="nn">Body</span><span class="p">::</span><span class="nf">empty</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
<span class="c1">// https として request する</span>
<span class="k">let</span> <span class="n">client</span> <span class="o">=</span> <span class="nn">hyper</span><span class="p">::</span><span class="nn">Client</span><span class="p">::</span><span class="nf">builder</span><span class="p">()</span><span class="py">.build</span><span class="p">::</span><span class="o">&lt;</span><span class="n">_</span><span class="p">,</span> <span class="nn">hyper</span><span class="p">::</span><span class="n">Body</span><span class="o">&gt;</span><span class="p">(</span><span class="n">https</span><span class="p">);</span>
<span class="k">let</span> <span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="nf">.request</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>
<span class="k">let</span> <span class="n">body</span> <span class="o">=</span> <span class="nn">hyper</span><span class="p">::</span><span class="nn">body</span><span class="p">::</span><span class="nf">aggregate</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>
<span class="k">let</span> <span class="n">json</span><span class="p">:</span> <span class="n">ResponseMetrics</span> <span class="o">=</span> <span class="nn">serde_json</span><span class="p">::</span><span class="nf">from_reader</span><span class="p">(</span><span class="n">body</span><span class="nf">.reader</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
<span class="k">let</span> <span class="n">metrics</span> <span class="o">=</span> <span class="n">json</span><span class="py">.metrics</span><span class="p">;</span>
</code></pre></div></div>

<p>値を取得したら、今度は同じように <strong>Slack</strong> の方も構造体を定義します。</p>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// リクエスト用構造体</span>
<span class="nd">#[derive(Serialize)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">SlackMessage</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">channel</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">sub_type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">text</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">username</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">as_user</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">}</span>
<span class="c1">// レスポンス用構造体</span>
<span class="nd">#[derive(Deserialize)]</span>
<span class="k">pub</span> <span class="k">struct</span> <span class="n">PostMessage</span> <span class="p">{</span>
    <span class="nd">#[allow(unused)]</span>
    <span class="n">channel</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>
<p>リクエストを組みたてて、POSTします。
見てわかると思いますが、ほとんど <strong>mackerel</strong> と変わらないです。</p>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// リクエスト body を json に変換</span>
<span class="k">let</span> <span class="n">json</span> <span class="o">=</span> <span class="nn">serde_json</span><span class="p">::</span><span class="nf">to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SlackMessage</span> <span class="p">{</span>
    <span class="n">channel</span><span class="p">:</span> <span class="s">"channel"</span><span class="nf">.to_string</span><span class="p">(),</span>
    <span class="n">sub_type</span><span class="p">:</span> <span class="s">"bot_message"</span><span class="nf">.to_string</span><span class="p">(),</span>
    <span class="n">text</span><span class="p">:</span> <span class="s">"message"</span><span class="nf">.to_string</span><span class="p">(),</span>
    <span class="n">username</span><span class="p">:</span> <span class="s">"botname"</span><span class="nf">.to_string</span><span class="p">(),</span>
    <span class="n">as_user</span><span class="p">:</span> <span class="k">true</span><span class="p">,</span>
<span class="p">})</span><span class="o">?</span><span class="p">;</span>

<span class="k">let</span> <span class="n">https</span> <span class="o">=</span> <span class="nn">hyper_tls</span><span class="p">::</span><span class="nn">HttpsConnector</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
<span class="k">let</span> <span class="n">req</span> <span class="o">=</span> <span class="nn">hyper</span><span class="p">::</span><span class="nn">Request</span><span class="p">::</span><span class="nf">builder</span><span class="p">()</span>
    <span class="nf">.method</span><span class="p">(</span><span class="nn">hyper</span><span class="p">::</span><span class="nn">Method</span><span class="p">::</span><span class="n">POST</span><span class="p">)</span>
    <span class="nf">.uri</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="nf">.header</span><span class="p">(</span><span class="s">"Content-Type"</span><span class="p">,</span> <span class="s">"application/json"</span><span class="p">)</span>
    <span class="nf">.header</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">,</span> <span class="nd">format!</span><span class="p">(</span><span class="s">"Bearer {}"</span><span class="p">,</span> <span class="nf">get_env</span><span class="p">(</span><span class="s">"SLACK_API_KEY"</span><span class="p">)))</span>
    <span class="nf">.body</span><span class="p">(</span><span class="nn">hyper</span><span class="p">::</span><span class="nn">Body</span><span class="p">::</span><span class="nf">from</span><span class="p">(</span><span class="n">json</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>

<span class="k">let</span> <span class="n">client</span> <span class="o">=</span> <span class="nn">hyper</span><span class="p">::</span><span class="nn">Client</span><span class="p">::</span><span class="nf">builder</span><span class="p">()</span><span class="py">.build</span><span class="p">::</span><span class="o">&lt;</span><span class="n">_</span><span class="p">,</span> <span class="nn">hyper</span><span class="p">::</span><span class="n">Body</span><span class="o">&gt;</span><span class="p">(</span><span class="n">https</span><span class="p">);</span>
<span class="k">let</span> <span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="nf">.request</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>
<span class="k">let</span> <span class="n">body</span> <span class="o">=</span> <span class="nn">hyper</span><span class="p">::</span><span class="nn">body</span><span class="p">::</span><span class="nf">aggregate</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="k">.await</span><span class="o">?</span><span class="p">;</span>
<span class="k">let</span> <span class="n">_json</span><span class="p">:</span> <span class="n">PostMessage</span> <span class="o">=</span> <span class="nn">serde_json</span><span class="p">::</span><span class="nf">from_reader</span><span class="p">(</span><span class="n">body</span><span class="nf">.reader</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
</code></pre></div></div>

<p>ポストするメッセージを作る際に2つのことをしています。
まずは <code class="language-plaintext highlighter-rouge">time</code> の <strong>UNIX EPOCH TIME</strong> からローカルの時間を表示するようにしています。
それと <strong>CO<sub>2</sub></strong> の値に依って絵文字を追加するかどうかを入れています。 <code class="language-plaintext highlighter-rouge">-1</code> とか予定していない値が入ってきた場合は <code class="language-plaintext highlighter-rouge">panic!</code> するようにしています。</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// chrono を利用して unix time からローカルの文字列へ変換</span>
<span class="k">let</span> <span class="n">t</span> <span class="o">=</span> <span class="nn">chrono</span><span class="p">::</span><span class="n">Local</span><span class="nf">.timestamp</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
<span class="k">let</span> <span class="n">v</span> <span class="o">=</span> <span class="k">match</span> <span class="n">value</span> <span class="p">{</span>
    <span class="mi">0</span><span class="o">..=</span><span class="mi">700</span> <span class="k">=&gt;</span> <span class="s">":large_green_circle:"</span><span class="p">,</span>
    <span class="mi">701</span><span class="o">..=</span><span class="mi">1000</span> <span class="k">=&gt;</span> <span class="s">":large_yellow_circle:"</span><span class="p">,</span>
    <span class="mi">1001</span><span class="o">..</span> <span class="k">=&gt;</span> <span class="s">":red_circle:"</span><span class="p">,</span> <span class="c1">// なんで slack は :large_red_circle: を用意していないんだろうか</span>
    <span class="n">_</span> <span class="k">=&gt;</span> <span class="nd">panic!</span><span class="p">(</span><span class="s">"unexpected number!!"</span><span class="p">),</span>
<span class="p">};</span>
</code></pre></div></div>

<p>こうやってポストされたメッセージは以下のようになります。</p>

<p><img src="/images/screenshot/posted-slack-message.png" alt="" /></p>

<p>絵文字つきでポストされましたね。</p>

<h2 id="まとめ">まとめ</h2>

<p><strong>Rust</strong> で <strong>bot</strong> を作ってみました。
と言ってもただの <strong>HTTP クライアント</strong> な <strong>bot</strong> なだけですけど。
一旦 <strong>Slack</strong> でも見えるようになったので今度は <a href="https://nature.global"><strong>Nature Remo</strong></a> と連携して気温や湿度での自動化ができたらいいな。</p>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:mackerel-token" role="doc-endnote">
      <p>https://mackerel.io/ja/api-docs/ <a href="#fnref:mackerel-token" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:slack-token" role="doc-endnote">
      <p>https://slack.com/intl/ja-jp/help/articles/215770388-API-%E3%83%88%E3%83%BC%E3%82%AF%E3%83%B3%E3%81%AE%E7%94%9F%E6%88%90%E3%81%A8%E5%86%8D%E7%94%9F%E6%88%90 <a href="#fnref:slack-token" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:slack-rs" role="doc-endnote">
      <p><a href="https://github.com/slack-rs/slack-rs">slack-rs</a> という便利ライブラリがあるのですが、ちょっと触ってみたこれは必要なんだっけ？となってやめました。 <a href="#fnref:slack-rs" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:hyper-warning" role="doc-endnote">
      <p><a href="https://github.com/hyperium/hyper#low-level">公式の README</a> にあるようにこの場合は <a href="https://github.com/seanmonstar/reqwest"><strong>reqwest</strong></a> を利用するほうがよかったかもしれない。<strong>TLS</strong> は直接 <strong>hyper</strong> が対応していなかったりしてすこし面倒です。 <a href="#fnref:hyper-warning" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <h1><a href="/blog/2021/12/31/me-and-coffee/">今年飲んだコーヒー豆の種類 2021</a></h1>
  <p class="author">
    <span class="date">2021-12-31 23:59:59 +0900</span>
  </p>
  <div class="content">
    <p>今年もコロナでどこにも行くにしても行きにくかったし、
店もどこもあまりやってなかったようだったので今年も酒ではないまとめを。</p>

<p>苦いコーヒーすこし飽きてきたなーとか、あんまり大量にのむのはなーと思ってたところ<sup id="fnref:coffee" role="doc-noteref"><a href="#fn:coffee" class="footnote" rel="footnote">1</a></sup>に
スペシャルティコーヒー専門店が近所にできていて、そこで飲んで教えてもらったコーヒーが
気に入りよく通うように。</p>

<p>普段の飲む量を1日1杯のみに抑えるために多少高くてもおいしい豆で1杯で満足できる豆を買うことにした。</p>

<h2 id="豆">豆</h2>

<p>買ったというのがわかっている豆。</p>

<ul>
  <li>HAMBELA WAMENA, HEIRLOOM, Natural, エチオピア</li>
  <li>Carmo De Minas Santuario Sul, Yellow Bourbon, Citrus Sweetness, ブラジル</li>
  <li>NYERI KARATINA, SL<sub>28</sub>SL<sub>32</sub>RUIRU<sub>11</sub>, Fully Washed, ケニア</li>
  <li>KAKAMEGA ISULU, SL<sub>28</sub>SL<sub>32</sub>RUIRU<sub>11</sub>, Natural Anaerobic, ケニア</li>
  <li>WEST ARSI GORA KONE, HEIRLOOM, Washed, エチオピア</li>
  <li>GEDEB WORKA, HEIRLOOM, Special Process Natural, エチオピア</li>
  <li>EL PARAISO RED FRUITS, CASTILLO, DOUBLE ANAEROBIC WASHED, コロンビア</li>
  <li>EL PARAISO LYCHEE, CASTILLO, DOUBLE ANAEROBIC WASHED, コロンビア</li>
  <li>NYERI MAGANJO, SL<sub>28</sub>SL<sub>32</sub>RUIRU<sub>11</sub>, Fully Washed, ケニア</li>
  <li>Fazenda Guariroba, Yellow Catuai, Double Fermentation Black Honey, ブラジル</li>
</ul>

<h2 id="感想">感想</h2>

<p>を書くつもりが、そもそも感想メモをほとんど残していなかった。いくつか残しているのでそれを。</p>

<ul>
  <li>EL PARAISO RED FRUITS: 別ロットはピーチティのような感じであったが、今回はかなりフルーティな味でライチな感じです。</li>
  <li>Fazenda Guariroba: 香りが柑橘系というかレモンの香りがする。味はスッキリしてて口に含んだ酸味は少なく、後味としての酸味が強くのこって美味しい。</li>
</ul>

<h2 id="まとめ">まとめ</h2>

<p>1年くらい前に社内 <strong>Slack</strong> にコーヒーの感想をまとめるためのチャンネル作ったけど、
まったく活用していなくて感想がほとんど残っていない。
おいしいこと以外は思いだせるわけもなく……</p>

<hr />
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:coffee" role="doc-endnote">
      <p>ここ1,2年コーヒー飲みすぎると胃が痛くなるのに気がついた。 <a href="#fnref:coffee" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <h1><a href="/blog/2021/12/30/custom-co2mini-co2-sensor/">custom CO2-mini で CO2 を見えるようにしよう</a></h1>
  <p class="author">
    <span class="date">2021-12-30 16:59:59 +0900</span>
  </p>
  <div class="content">
    <p>コロナになって結構前に <a href="https://www.kk-custom.co.jp/emp/CO2-mini.html"><strong>custom CO2-mini</strong></a>
に <a href="https://www.itmedia.co.jp/pcuser/articles/2012/18/news069.html">話題になった</a>
ので買って放置してあったの<sup id="fnref:buy-co2mon" role="doc-noteref"><a href="#fn:buy-co2mon" class="footnote" rel="footnote">1</a></sup> を活用しようと思いたった。
とりあえず値は取得はできているので <a href="https://meckerel.io"><strong>mackerel</strong></a> との連携をしてグラフに表示できるようにします。
あと  <strong>mercker-plugin</strong> を <a href="https://www.rust-lang.org"><strong>Rust</strong></a> で書いてみたいとおもったので、やってみることにしました。</p>

<p>以下のリポジトリにコードはあります。</p>

<p><a href="https://github.com/katsyoshi/mackerel-plugin-co2mon"><img src="https://gh-card.dev/repos/katsyoshi/mackerel-plugin-co2mon.svg" alt="katsyoshi/mackerel-plugin-co2mon - GitHub" /></a></p>

<h2 id="mackerel-plugin-として作る">mackerel plugin として作る</h2>
<p><strong>mackerel</strong> に投稿する前にこの <strong>custom CO2-mini</strong> が <strong>Rust</strong> で読めるのかを調査してみましたら、<a href="https://crates.io/crates/co2mon"><strong>co2mon</strong></a> がピンズドな感じでありました。
確認としてセンサーの読み込みは <strong>co2mon</strong> の <a href="https://github.com/lnicola/co2mon#permissions">README の通り</a> にやることで読みとることができます。</p>

<p>センサーの値が読み込めるようになったら、今度は <strong>mackerel</strong> へ投げれるようにします。
と言ってもやることは <a href="https://mackerel.io/ja/docs/entry/advanced/custom-metrics#post-metric">公式にあるよう</a> に以下のフォーマットで標準出力に出すだけのようです。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{metric name}\t{metric value}\t{unix epoch time}
</code></pre></div></div>

<p>ということなので適当に <strong>metric name</strong> を <code class="language-plaintext highlighter-rouge">CO2MINI.co2/temp.living</code> <sup id="fnref:custom-co2mini" role="doc-noteref"><a href="#fn:custom-co2mini" class="footnote" rel="footnote">2</a></sup> にして出力しています。
<strong>mackerel-plugin</strong> として動かすために、 <strong>mackerel-agent.conf</strong> に以下のような設定を追加し、再起動することでグラフが追加できます。</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[plugin.metrics.CO2MINI]</span>
<span class="py">command</span> <span class="p">=</span> <span class="p">[</span><span class="s">"/path/to/build/bin/mackerel-plugin-co2mon"</span><span class="p">]</span>
</code></pre></div></div>

<p>グラフは以下のように表示されました!やったね!
<img src="/images/screenshot/co2mini-metrics.png" alt="" /></p>

<h2 id="おわり">おわり</h2>

<p>ずっとやろうやろうと思ってた <strong>Rust</strong> で <strong>mackerel</strong> のプラグイン作成、
面倒で先延しにしてたのですが、チョットやってみたらすぐにできたのでよかったです。
今後としては <strong>CO<sub>2</sub></strong> の値に応じて窓開けたりできるようにしたいなあと思っています<sup id="fnref:window" role="doc-noteref"><a href="#fn:window" class="footnote" rel="footnote">3</a></sup>。</p>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:buy-co2mon" role="doc-endnote">
      <p>Amazon で確認したら買ったの 2020/03 だった…… <a href="#fnref:buy-co2mon" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:custom-co2mini" role="doc-endnote">
      <p>mackerel のグラフ表示部分のタイトルが <code class="language-plaintext highlighter-rouge">custom.CO2MINI.co2.living</code> となり、メーカー名も入っていいじゃんとなった。 <a href="#fnref:custom-co2mini" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:window" role="doc-endnote">
      <p>窓開閉する道具もないのでそこから仕入れる必要がありいつになるか不明です。 <a href="#fnref:window" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <h1><a href="/blog/2021/12/26/xremap/">いんとろでぅーす xremap</a></h1>
  <p class="author">
    <span class="date">2021-12-26 13:59:59 +0900</span>
  </p>
  <div class="content">
    <p>仕事で利用したりしている <strong>Slack</strong> などのキーボードでの操作が面倒になってきたので、
<strong>emacs keybind</strong> が利用できるようにするため <a href="https://github.com/k0kubun/xremap"><strong>xremap</strong></a> を利用することにした。</p>

<p>この記事はその利用するまでの顛末をメモとして残す。</p>

<h2 id="導入">導入</h2>

<p>これは、さくっと <code class="language-plaintext highlighter-rouge">cargo install xremap</code> でインストールできます。
<a href="https://www.rust-lang.org"><strong>rust</strong></a> をまだ導入していない方は <a href="https://www.rust-lang.org/tools/install">公式ページのインストール</a> を参考にインストールしてください。</p>

<h2 id="起動">起動!!!</h2>

<p>これも簡単で以下のコマンドで起動します。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xremap /path/to/your/xremap/config.yml
</code></pre></div></div>

<h3 id="エラーに遭遇">エラーに遭遇</h3>

<p>起動してみると以下のようなメッセージが出て起動ができませんでした。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Selecting devices from the following list:
------------------------------------------------------------------------------
/dev/input/event0 : Power Button
/dev/input/event1 : Power Button
/dev/input/event2 : HDA NVidia HDMI/DP,pcm=3
/dev/input/event3 : HDA NVidia HDMI/DP,pcm=7
/dev/input/event4 : HDA NVidia HDMI/DP,pcm=8
/dev/input/event5 : HDA NVidia HDMI/DP,pcm=9
/dev/input/event6 : HDA NVidia HDMI/DP,pcm=10
/dev/input/event7 : HDA NVidia HDMI/DP,pcm=11
/dev/input/event8 : Pekaso The Fortitude60 Keyboard
/dev/input/event9 : Pekaso The Fortitude60 Keyboard Mouse
/dev/input/event10: Pekaso The Fortitude60 Keyboard System Control
/dev/input/event11: Pekaso The Fortitude60 Keyboard Consumer Control
/dev/input/event12: Kensington Kensington Slimblade Trackball
/dev/input/event13: Burr-Brown from TI               USB Audio CODEC
/dev/input/event14: HD Web Camera: HD Web Camera
------------------------------------------------------------------------------
Selected keyboards automatically since --device options weren't specified:
------------------------------------------------------------------------------
/dev/input/event8 : Pekaso The Fortitude60 Keyboard
------------------------------------------------------------------------------
Error: Failed to build an output device: no such file or directory (os error 2)
</code></pre></div></div>

<p>で、答えは出てるので設定ファイル、対象となる入力デバイスなどを見ますが、
これらのファイルはあるのでわからんとなります。</p>

<p>しかたないのでソースをダウンロードして手元でデバッグしてみます。
<strong>rust</strong> というか <strong>cargo</strong> は便利で、<code class="language-plaintext highlighter-rouge">cargo run</code> でソースをいじったあとすぐにコンパイルして利用することができます。
今回はメンドウなので怪しいところに <code class="language-plaintext highlighter-rouge">println</code> 文を挿入して実行してみます。
そうすると、どうやら <a href="https://github.com/k0kubun/xremap/blob/f058c444335c153e638ecf3c76492cdf9f8a975d/src/output.rs#L39-L43"><code class="language-plaintext highlighter-rouge">src/output.rs</code> の 39 行目の <code class="language-plaintext highlighter-rouge">VirtualDeviceBuilder</code> に問題がありそう</a> ということがわかりました。</p>

<p>この行のどこに問題あるんだ？と思い利用しているこのライブラリ <a href="https://docs.rs/evdev"><strong>evdev</strong></a> を見ることにしました<sup id="fnref:evdev-rs" role="doc-noteref"><a href="#fn:evdev-rs" class="footnote" rel="footnote">1</a></sup>。
そうすると <a href="https://docs.rs/evdev/latest/src/evdev/uinput.rs.html#13"><code class="language-plaintext highlighter-rouge">/dev/uinput</code> が必要</a> ということがわかります。
それで <code class="language-plaintext highlighter-rouge">/dev/uinput</code> があるかどうか <code class="language-plaintext highlighter-rouge">ls</code> で見ますが、当然無いので無いです。
なぜ無いのかというと <code class="language-plaintext highlighter-rouge">INPUT_UINPUT</code> でドライバーを入れていなかったようです。
なのでカーネルのビルトインとしてビルドして再起動。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Defined at drivers/input/misc/Kconfig:513
     Prompt: User level driver support
     Depends on: INPUT [=y] &amp;&amp; INPUT_MISC [=y]
     Location:
       -&gt; Device Drivers
         -&gt; Input device support
           -&gt; Generic input layer (needed for keyboard, mouse, ...) (INPUT [=y])
             -&gt; Miscellaneous devices (INPUT_MISC [=y])
               -&gt; User level driver support
</code></pre></div></div>

<p>再起動したら、確認を行ないます。</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ xremap ~/.config/xremap/config.yml
Selecting devices from the following list:
------------------------------------------------------------------------------
/dev/input/event0 : Power Button
/dev/input/event1 : Power Button
/dev/input/event2 : HDA NVidia HDMI/DP,pcm=3
/dev/input/event3 : HDA NVidia HDMI/DP,pcm=7
/dev/input/event4 : HDA NVidia HDMI/DP,pcm=8
/dev/input/event5 : HDA NVidia HDMI/DP,pcm=9
/dev/input/event6 : HDA NVidia HDMI/DP,pcm=10
/dev/input/event7 : HDA NVidia HDMI/DP,pcm=11
/dev/input/event8 : Pekaso The Fortitude60 Keyboard
/dev/input/event9 : Pekaso The Fortitude60 Keyboard Mouse
/dev/input/event10: Pekaso The Fortitude60 Keyboard System Control
/dev/input/event11: Pekaso The Fortitude60 Keyboard Consumer Control
/dev/input/event12: Kensington Kensington Slimblade Trackball
/dev/input/event13: Burr-Brown from TI               USB Audio CODEC
/dev/input/event14: HD Web Camera: HD Web Camera
------------------------------------------------------------------------------
Selected keyboards automatically since --device options weren't specified:
------------------------------------------------------------------------------
/dev/input/event8 : Pekaso The Fortitude60 Keyboard
------------------------------------------------------------------------------
</code></pre></div></div>

<p>yatta 起動できた!
あとは、アプリでキーバインドが効いているかどうかを確認して、
<strong>Window Manager</strong> である <strong>i3</strong> の起動時に <strong>xremap</strong> が起動するようにしたりしています。</p>

<h2 id="おわり">おわり</h2>
<p>最近、 <strong>Mac</strong> との行き来をしていると <strong>emacs keybind</strong> が使えないときにちょっといらっとしますので使えるようにキーバインドを変更してみました。
設定ファイルの動的読み込みに対応していないのがちょっと面倒なのですが<sup id="fnref:hotreload" role="doc-noteref"><a href="#fn:hotreload" class="footnote" rel="footnote">2</a></sup>、これで <strong>Slack</strong> などで <code class="language-plaintext highlighter-rouge">C-a</code> で行頭にもどれるようになりました。便利。</p>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:evdev-rs" role="doc-endnote">
      <p>はじめは似た名前のライブラリの <a href="https://github.com/ndesh26/evdev-rs"><code class="language-plaintext highlighter-rouge">evdev-rs</code></a> を見てたのですが、対象であるはずのファイル内に宣言されていないのでちょっととまどい、このライブラリは違うやつだとなり <a href="https://crates.io">crates.io</a> で再検索して発見しています。 <a href="#fnref:evdev-rs" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:hotreload" role="doc-endnote">
      <p>どうせ1回確認できたら再起動する必要はないので問題ないといえば問題ないけど、ちょっと面倒。 <a href="#fnref:hotreload" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <h1><a href="/blog/2021/12/06/yancya-club-and-rubyist/">やんちゃクラブとRubyistと川</a></h1>
  <p class="author">
    <span class="date">2021-12-06 23:59:59 +0900</span>
  </p>
  <div class="content">
    <p>おはようございます、 2021年、12月6日 のよるだったり、12月7日の朝だったりします。</p>

<p>これは <a href="https://adventar.org/calendars/6668">やんちゃクラブリスナーアドベントカレンダー</a> の6日目だったり、
<a href="https://adventar.org/calendars/6777">Rubyist近況[1]アドベントカレンダー</a> の7日目だったりします。</p>

<p>最近仕事としては Rails 6.1 にしたり、 Ruby-3.0 にしてたり、java 書いてたりしています。</p>

<p>コロナになり、RubyKaigi後恒例の <strong>川</strong> がなくなってかなりさみしい思いをしている方もいらっしゃるとおもいますので、
東京近郊でのよい <strong>川</strong> をまとめてみたいとおもいます。</p>

<h2 id="川">川</h2>

<ol>
  <li><a href="https://www.google.com/maps/place/%E3%80%92120-0034+%E6%9D%B1%E4%BA%AC%E9%83%BD%E8%B6%B3%E7%AB%8B%E5%8C%BA%E5%8D%83%E4%BD%8F%EF%BC%95%E4%B8%81%E7%9B%AE/@35.7563561,139.8029477,17z/data=!3m1!4b1!4m5!3m4!1s0x60188e4823ec7b73:0xf626ddac28b8deac!8m2!3d35.7562782!4d139.8054747">荒川： 虹の広場</a></li>
  <li><a href="https://www.google.com/maps/place/%E5%8F%B0%E6%9D%B1%E5%8C%BA%E7%AB%8B+%E9%9A%85%E7%94%B0%E5%85%AC%E5%9C%92/@35.7247541,139.8060852,15.75z/data=!4m9!1m2!2m1!1z5aKo55Sw5YWs5ZyS!3m5!1s0x60188ec349138a67:0xc95c03b0375fa0d7!8m2!3d35.7107642!4d139.7982715!15sCgzloqjnlLDlhazlnJJaDyIN5aKo55SwIOWFrOWckpIBBHBhcms">墨田川： 墨田公園</a></li>
  <li><a href="https://www.google.com/maps/place/%E3%80%92214-0003+%E7%A5%9E%E5%A5%88%E5%B7%9D%E7%9C%8C%E5%B7%9D%E5%B4%8E%E5%B8%82%E5%A4%9A%E6%91%A9%E5%8C%BA%E8%8F%85%E7%A8%B2%E7%94%B0%E5%A0%A4%EF%BC%92%E4%B8%81%E7%9B%AE%EF%BC%91%EF%BC%90%E2%88%92%EF%BC%92%EF%BC%92/@35.6383952,139.5346417,18z/data=!3m1!4b1!4m5!3m4!1s0x6018f07a89b9d099:0x77385278ffea0854!8m2!3d35.6383952!4d139.535736">多摩川： 稲田堤</a></li>
  <li><a href="https://www.google.com/maps/search/%E3%80%92272-0111+%E5%8D%83%E8%91%89%E7%9C%8C%E5%B8%82%E5%B7%9D%E5%B8%82%E5%A6%99%E5%85%B8%EF%BC%96%E4%B8%81%E7%9B%AE%EF%BC%91%E2%88%92%EF%BC%91/@35.6945582,139.9282683,17z/data=!3m1!4b1">江戸川： 妙典公園、江戸川河川敷緑地</a></li>
</ol>

<h3 id="荒川-虹の広場">荒川： 虹の広場</h3>

<p>ここは <a href="https://twitter.com/yancya">yancyaさん</a> の地元で一緒によく行く川です。
ここの <strong>最高</strong> は大きな街(北千住)が近く、ふらっと行っても調達が楽なところで、たべもの、のみものなんでも楽に調達できます。
とくにのみものは国外のクラフトビールがたくさん買える場所あるので <strong>最高</strong> なのと、クラフトビール作ってる場所があるので <strong>最高</strong> なのです。
また、公園のような場所なので花火できます。バーベキューとか火を使うのは岩渕水門あたりじゃないとできないので気をつけてください。</p>

<p>周りに邪魔をするようなものがとくにないので、日の入りやスカイツリーが綺麗に見えます。
そばに電車(東武伊勢崎線、TX、常磐線)が通っているので電車を眺めるのもいいです。</p>

<p>時期としては春から秋にかけて行くのが <strong>最高</strong> ですね。冬はまだ行ったことないのでそのうち試してみるかもしれないです。</p>

<h3 id="墨田川-墨田公園">墨田川： 墨田公園</h3>

<p>墨田公園といえば <a href="https://www.sakuranokai.or.jp/information/local5/">さくらの名所100選</a> に選ばれるほどの桜の名所です。
ここも浅草という大きな街が近くなので、調達が楽です。しかしながら、桜の季節は人が多いので調達は事前にして <strong>川</strong> するのがよいです。</p>

<p>見所としてはもちろん桜です。ここも東武伊勢崎線がとおってるのと、浅草名物アサヒビールの建物、スカイツリーが見えるので桜の時期とくに映えますね。
やんちゃクラブで紹介されたように、水上バスの発着場があるので水上バスを利用するのもおもしろいと思います。</p>

<p>時期としては <strong>最高</strong> なのはもちろん桜の時期です。それ以外の時期でも場所が浅草なので、風が強い日以外はオールシーズン <strong>川</strong> デキルと思います。
風が強かったら逃げれる場所たくさんあるのでよいですよ。</p>

<h3 id="多摩川-稲田堤">多摩川： 稲田堤</h3>

<p>ここの <strong>最高</strong> さは、<a href="https://tabelog.com/kanagawa/A1405/A140506/14014188/">たぬきや</a> という夏の間だけやっている(と飲み仲間に教えてもらった)
川の家があったのですが、去年あたりに終ってしまった。川辺にあるお店で、川を眺めながら飲むビールとか <strong>最高</strong> でした。</p>

<p>見所としては今説明したたぬきやです。ジェットスキーとかできるんならもっと楽しめるんじゃないんですかね。</p>

<p><strong>最高</strong> な時期としては夏だったのですが、もう行ってもね……</p>

<h3 id="江戸川-妙典公園江戸川河川敷緑地">江戸川： 妙典公園、江戸川河川敷緑地</h3>

<p>ここは虹の広場とは違い、バーベキュー場があり火が使えるようです。火が使えるのでスモークとかやると <strong>最高</strong> かと。
ただ、駅から遠いのと、街が近くないので調達は事前にやっておくとよいです。近くに大型スーパーがあるのですが、クラフトビールなどの飲みものがイマイチ(個人的感想)です。</p>

<p><strong>最高</strong> な時期は夏じゃないですかね、BBQとかはよくわからないですが……</p>

<h2 id="まとめ">まとめ</h2>

<p><strong>最高</strong> な東京の <strong>川</strong> をまとめてみました。コロナのため最近 <strong>川</strong> できていないですので、みんなコロナ開けたら <strong>川</strong> しような!</p>

<p><a href="https://adventar.org/calendars/6668">やんちゃクラブリスナーアドベントカレンダー</a> の次は12/7の <a href="https://twitter.com/igaiga555">igaigaさん</a> です。
<a href="https://adventar.org/calendars/6777">Rubyist近況[1]アドベントカレンダー</a> の次は12/10のKirika_K2さんです。</p>

  </div>


<!-- Pagination links -->
<div class="pagination">
  
    <a href="/" class="previous">
      Previous
    </a>
  
  <span class="page_number ">
    Page: 2 of 12
  </span>
  
    <a href="/page/3/" class="next">Next</a>
  
</div>


      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">katsyoshi のめもみたいなの</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">katsyoshi のめもみたいなの</li><li><a class="u-email" href="mailto:web@katsyoshi.org">web@katsyoshi.org</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/katsyoshi"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">katsyoshi</span></a></li><li><a href="https://www.twitter.com/katsyoshi"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">katsyoshi</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>It&#39;s a memos.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
